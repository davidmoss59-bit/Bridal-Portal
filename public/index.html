<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personata Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #0a0a0f; color: #f5f5f5; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 0; border-bottom: 1px solid #333; margin-bottom: 30px; }
        h1 { font-size: 2.5rem; background: linear-gradient(135deg, #d4a574, #c77d8e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { color: #888; margin-top: 10px; }
        
        .setup-box { background: #12121a; border: 1px solid #d4a574; border-radius: 15px; padding: 30px; max-width: 500px; margin: 50px auto; }
        .form-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .form-group { flex: 1; }
        label { display: block; color: #888; margin-bottom: 8px; font-size: 14px; }
        input, select { width: 100%; padding: 12px; background: #0a0a0f; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 16px; }
        input:focus, select:focus { outline: none; border-color: #d4a574; }
        button { padding: 12px 24px; background: linear-gradient(135deg, #d4a574, #c77d8e); border: none; border-radius: 8px; color: #0a0a0f; font-weight: 600; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-full { width: 100%; margin-top: 20px; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .btn-outline { background: transparent; border: 1px solid #d4a574; color: #d4a574; }
        .btn-outline:hover { background: rgba(212,165,116,0.1); }
        
        .territory-info { background: rgba(212,165,116,0.1); padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .territory-info.show { display: block; }
        .territory-name { font-size: 1.3rem; color: #d4a574; }
        .territory-detail { color: #888; font-size: 14px; margin-top: 5px; }
        
        .main-app { display: none; }
        .main-app.show { display: block; }
        .setup-screen { display: block; }
        .setup-screen.hide { display: none; }
        
        .badge { display: inline-block; background: rgba(212,165,116,0.2); border: 1px solid #d4a574; padding: 8px 16px; border-radius: 20px; color: #d4a574; font-size: 14px; margin-top: 10px; }
        .badge a { color: #888; margin-left: 10px; cursor: pointer; text-decoration: underline; }
        .badge a:hover { color: #d4a574; }
        
        .tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #12121a; border: 1px solid #333; border-radius: 8px; color: #888; cursor: pointer; }
        .tab:hover { border-color: #d4a574; color: #fff; }
        .tab.active { background: rgba(212,165,116,0.2); border-color: #d4a574; color: #d4a574; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .section-title { font-size: 1.5rem; color: #d4a574; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        
        .info-box { background: rgba(100,180,200,0.1); border: 1px solid rgba(100,180,200,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #888; font-size: 14px; }
        .info-box strong { color: #7dd3e8; }
        
        .vendor-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .vendor-controls select { width: auto; min-width: 180px; }
        
        .vendor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .vendor-card { background: #12121a; border: 1px solid #333; border-radius: 10px; padding: 15px; }
        .vendor-card:hover { border-color: #d4a574; }
        .vendor-card.vendor-contacted { border-color: #8fd4a8; background: rgba(143,212,168,0.05); }
        .vendor-type { font-size: 11px; color: #d4a574; text-transform: uppercase; margin-bottom: 5px; }
        .vendor-name { font-weight: 600; margin-bottom: 5px; font-size: 1.1rem; }
        .vendor-address { font-size: 13px; color: #666; margin-bottom: 5px; }
        .vendor-phone { font-size: 13px; color: #888; margin-bottom: 8px; }
        .vendor-phone a { color: #7dd3e8; text-decoration: none; }
        .vendor-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .vendor-link { padding: 6px 12px; background: #0a0a0f; border: 1px solid #333; border-radius: 6px; color: #888; text-decoration: none; font-size: 12px; }
        .vendor-link:hover { border-color: #d4a574; color: #d4a574; }
        .contacted-date { font-size: 11px; color: #8fd4a8; margin-top: 5px; }
        
        .contact-checkbox { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: #666; }
        .contact-checkbox input { display: none; }
        .contact-checkbox .checkmark { width: 18px; height: 18px; border: 2px solid #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .contact-checkbox input:checked + .checkmark { background: #8fd4a8; border-color: #8fd4a8; }
        .contact-checkbox input:checked + .checkmark::after { content: '‚úì'; color: #0a0a0f; font-size: 12px; font-weight: bold; }
        .contact-checkbox:hover .checkmark { border-color: #8fd4a8; }
        .contact-checkbox .contact-label { color: #666; }
        .contact-checkbox input:checked ~ .contact-label { color: #8fd4a8; }
        
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; color: #888; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: #d4a574; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; }
        .loading-sub { font-size: 12px; color: #666; margin-top: 5px; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #d4a574, #c77d8e); color: #0a0a0f; padding: 12px 20px; border-radius: 8px; font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat { background: #12121a; border: 1px solid #333; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2rem; color: #d4a574; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: #12121a; border: 1px solid #333; border-radius: 12px; padding: 20px; }
        .card:hover { border-color: #d4a574; }
        .card-type { display: inline-block; padding: 4px 10px; background: rgba(212,165,116,0.2); color: #d4a574; font-size: 12px; border-radius: 4px; margin-bottom: 10px; text-transform: uppercase; }
        .card-title { font-size: 1.1rem; margin-bottom: 10px; }
        .card-content { color: #888; font-size: 14px; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px; max-height: 150px; overflow: hidden; }
        .card-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #d4a574; font-size: 12px; text-transform: uppercase; }
        td { color: #888; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-ok { background: rgba(100,200,150,0.2); color: #8fd4a8; }
        .status-vendor { background: rgba(212,165,116,0.2); color: #d4a574; }
        
        .search-links { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .search-link { padding: 10px 16px; background: #0a0a0f; border: 1px solid #7dd3e8; border-radius: 6px; color: #7dd3e8; text-decoration: none; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .search-link:hover { background: #7dd3e8; color: #0a0a0f; }
        
        .featured { background: linear-gradient(135deg, rgba(212,165,116,0.15), rgba(199,125,142,0.08)); border: 2px solid #d4a574; border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: center; }
        .featured-label { font-size: 12px; color: #d4a574; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .featured-title { font-size: 1.4rem; margin-bottom: 15px; }
        .featured-content { color: #888; max-width: 600px; margin: 0 auto 20px; white-space: pre-wrap; line-height: 1.7; }
        
        .ai-box { background: linear-gradient(135deg, rgba(212,165,116,0.1), rgba(199,125,142,0.05)); border: 1px solid #d4a574; border-radius: 15px; padding: 25px; margin-bottom: 25px; }
        .ai-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .ai-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #d4a574, #c77d8e); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .ai-title { font-size: 1.3rem; color: #d4a574; }
        .ai-subtitle { color: #888; font-size: 13px; }
        .gen-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .gen-btn { padding: 15px; background: #12121a; border: 1px solid #333; border-radius: 10px; cursor: pointer; text-align: left; color: #888; }
        .gen-btn:hover { border-color: #d4a574; }
        .gen-btn .icon { font-size: 20px; margin-bottom: 5px; }
        .gen-btn .label { font-weight: 600; color: #fff; font-size: 14px; }
        .gen-btn .desc { font-size: 12px; margin-top: 3px; }
        .output-box { background: #12121a; border: 1px solid #333; border-radius: 12px; padding: 20px; min-height: 200px; margin-top: 20px; }
        .output-item { background: #0a0a0f; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .output-item:hover { border-color: #d4a574; }
        .output-type { font-size: 11px; color: #d4a574; text-transform: uppercase; margin-bottom: 5px; }
        .output-content { color: #ccc; white-space: pre-wrap; margin-bottom: 10px; font-size: 14px; line-height: 1.6; }
        
        .error-box { background: rgba(200,100,100,0.1); border: 1px solid rgba(200,100,100,0.3); color: #e88; padding: 15px; border-radius: 8px; margin: 20px 0; }
        
        .vendor-count { background: rgba(212,165,116,0.2); padding: 4px 12px; border-radius: 12px; font-size: 13px; color: #d4a574; }

        /* ===== Songwriter Brief Builder Styles ===== */
        #songwriter .sw-sh{margin-bottom:32px}
        #songwriter .sw-sh h2{font-family:'Playfair Display',serif;font-size:28px;font-weight:600;color:#f5f5f5;margin-bottom:8px}
        #songwriter .sw-sh p{font-size:14px;color:#888;max-width:640px}
        #songwriter .sw-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(212,165,116,.15);border:1px solid #9a7d3d;border-radius:20px;padding:6px 16px;margin-bottom:24px;font-size:12px;font-weight:600;color:#d4a574;text-transform:uppercase;letter-spacing:1px}
        #songwriter .sw-badge .d{width:8px;height:8px;border-radius:50%;background:#d4a574}
        #songwriter .sw-fg{margin-bottom:24px}
        #songwriter .sw-fr{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        #songwriter .sw-fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
        #songwriter .sw-cd{background:#12121a;border:1px solid #333;border-radius:12px;padding:28px;margin-bottom:20px}
        #songwriter .sw-cd-g{background:rgba(212,165,116,.06);border-color:#9a7d3d}
        #songwriter .sw-scg{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin:32px 0}
        #songwriter .sw-scb{aspect-ratio:1;border:2px solid #333;border-radius:12px;background:#12121a;color:#f5f5f5;font-family:'Playfair Display',serif;font-size:32px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        #songwriter .sw-scb:hover{border-color:#9a7d3d;background:#1e1e2a}
        #songwriter .sw-scb.sel{border-color:#d4a574;background:rgba(212,165,116,.15);color:#d4a574;box-shadow:0 0 30px rgba(212,165,116,.15)}
        #songwriter .sw-pc{background:#12121a;border:1px solid #333;border-radius:12px;padding:24px;margin-bottom:16px}
        #songwriter .sw-pch{display:flex;align-items:flex-start;gap:16px;margin-bottom:16px}
        #songwriter .sw-pn{flex-shrink:0;width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#d4a574,#9a7d3d);color:#0a0a0f;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace}
        #songwriter .sw-pti{flex:1}
        #songwriter .sw-pti input{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;background:transparent;border:none;border-bottom:1px solid #333;border-radius:0;padding:8px 4px;color:#f5f5f5}
        #songwriter .sw-pti input:focus{border-color:#d4a574;box-shadow:none}
        #songwriter .sw-nf{display:flex;justify-content:space-between;margin-top:48px;padding-top:24px;border-top:1px solid #333}
        #songwriter .sw-ht{font-size:12px;color:#888;margin-top:6px;font-style:italic}
        #songwriter .sw-sec{animation:sw-fi .3s ease}
        @keyframes sw-fi{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
        #songwriter .sw-pvc{background:#fff;color:#1a1a1a;border-radius:12px;padding:48px;font-family:Georgia,serif;line-height:1.7;max-height:70vh;overflow-y:auto}
        #songwriter .sw-pvc::-webkit-scrollbar-thumb{background:#ccc}
        #songwriter .sw-pvc::-webkit-scrollbar-track{background:#f5f5f5}
        #songwriter .sw-pvb{text-align:center;font-size:14px;letter-spacing:4px;text-transform:uppercase;font-weight:700;color:#333}
        #songwriter .sw-pvr{border:none;border-top:2px solid #333;margin:16px 0}
        #songwriter .sw-pvrl{border:none;border-top:1px solid #ddd;margin:16px 0}
        #songwriter .sw-pvt{text-align:center;font-size:22px;margin:8px 0 4px;color:#1a1a1a}
        #songwriter .sw-pvs{text-align:center;font-style:italic;color:#666;font-size:13px;margin-bottom:8px}
        #songwriter .sw-pvm{text-align:center;font-size:12px;color:#999;margin-bottom:16px;line-height:1.8}
        #songwriter .sw-pvst{font-size:15px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:24px 0 12px;color:#1a1a1a}
        #songwriter .sw-pvpb{border:1px solid #ddd;padding:16px 20px;margin-bottom:20px;line-height:1.8;font-size:14px;color:#1a1a1a}
        #songwriter .sw-pvpb strong{color:#333}
        #songwriter .sw-pvpt{margin-bottom:16px;padding-left:20px;border-left:3px solid #ddd;font-size:14px;color:#1a1a1a}
        #songwriter .sw-pvpt strong{color:#222}
        #songwriter .sw-pvvb{border:1px solid #bbb;padding:16px 20px;margin-top:24px;font-style:italic;font-size:14px;color:#444}
        #songwriter .sw-pvf{text-align:center;margin-top:32px;font-size:12px;color:#999;letter-spacing:2px;text-transform:uppercase}
        #songwriter .sw-pvsh{text-align:center;margin:40px 0 16px;padding:20px 0;border-top:2px solid #333;border-bottom:1px solid #ddd}
        #songwriter label{color:#888}
        #songwriter input[type="text"],#songwriter input[type="number"],#songwriter textarea,#songwriter select{background:#0a0a0f;border:1px solid #333;border-radius:8px;color:#fff;font-family:'DM Sans',system-ui,sans-serif;font-size:14px;padding:12px 16px;width:100%;outline:none;transition:all .2s}
        #songwriter input:focus,#songwriter textarea:focus,#songwriter select:focus{border-color:#d4a574;box-shadow:0 0 0 3px rgba(212,165,116,.15)}
        #songwriter textarea{min-height:100px;resize:vertical;line-height:1.7}
        #songwriter textarea.sw-tl{min-height:160px}
        #songwriter select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
        #songwriter ::placeholder{color:#666;opacity:.6}
        #songwriter .sw-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:1px solid #333;border-radius:8px;background:#12121a;color:#f5f5f5;font-family:'DM Sans',system-ui,sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;letter-spacing:.3px}
        #songwriter .sw-btn:hover{border-color:#9a7d3d;background:#1e1e2a}
        #songwriter .sw-btn-p{background:#d4a574;color:#0a0a0f;border-color:#d4a574;font-weight:600}
        #songwriter .sw-btn-p:hover{background:#e0b884;border-color:#e0b884}
        #songwriter .sw-btn svg{width:16px;height:16px}
        #songwriter .sw-btn:disabled{opacity:.4;cursor:not-allowed;pointer-events:none}
        #sw-pbar .sw-pstep{flex:1;display:flex;flex-direction:column;align-items:center;position:relative;cursor:pointer;min-width:52px}
        #sw-pbar .sw-pstep::before{content:'';position:absolute;top:14px;left:50%;right:-50%;height:2px;background:#333;z-index:0}
        #sw-pbar .sw-pstep:last-child::before{display:none}
        #sw-pbar .sw-pstep.done::before{background:#9a7d3d}
        #sw-pbar .sw-pdot{width:32px;height:32px;border-radius:50%;border:2px solid #333;background:#0a0a0f;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#888;position:relative;z-index:1;transition:all .2s}
        #sw-pbar .sw-pstep.on .sw-pdot{border-color:#d4a574;color:#d4a574;box-shadow:0 0 16px rgba(212,165,116,.15)}
        #sw-pbar .sw-pstep.done .sw-pdot{border-color:#d4a574;background:#d4a574;color:#0a0a0f}
        #sw-pbar .sw-plbl{margin-top:5px;font-size:9px;color:#888;letter-spacing:.3px;text-transform:uppercase;font-weight:500;white-space:nowrap;text-align:center}
        #sw-pbar .sw-pstep.on .sw-plbl{color:#d4a574}
        #sw-pbar .sw-pstep.done .sw-plbl{color:#bbb}
        @media(max-width:768px){#songwriter .sw-fr,#songwriter .sw-fr3{grid-template-columns:1fr}#songwriter .sw-scg{grid-template-columns:repeat(3,1fr)}#songwriter .sw-pvc{padding:24px}#sw-pbar .sw-plbl{font-size:7px}}
    </style>
</head>
<body>
    <div class="setup-screen" id="setupScreen">
        <!-- Clean Hero Section -->
        <div style="min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 20px;text-align:center">
            <!-- Logo -->
            <div style="font-family:Georgia,serif;font-size:2.5rem;font-style:italic;color:#d4a574;margin-bottom:60px">Personata</div>
            
            <!-- Headline -->
            <h1 style="font-family:Georgia,serif;font-size:clamp(2.5rem,6vw,4rem);line-height:1.15;margin-bottom:25px;font-weight:normal;max-width:700px">
                <span style="color:#fff">Elevate Your</span><br>
                <span style="color:#d4a574;font-style:italic">Bridal Outreach</span>
            </h1>
            
            <!-- Subheadline -->
            <p style="color:#888;font-size:1.15rem;line-height:1.7;margin-bottom:50px;max-width:520px">
                The ultimate command center for wedding professionals. Manage vendors, track outreach groups, and draft perfect messages with AI.
            </p>
            
            <!-- Button -->
            <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center">
                <button id="signInBtn" style="display:inline-flex;align-items:center;gap:12px;padding:18px 50px;background:#d4a574;border:none;border-radius:50px;color:#0a0a0f;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s">
                    Sign In <span style="font-size:1.2rem">‚Üí</span>
                </button>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;align-items:center;justify-content:center;padding:20px">
            <div style="background:#12121a;border:1px solid #d4a574;border-radius:20px;padding:40px;max-width:420px;width:100%;position:relative">
                <button id="closeAuthModal" style="position:absolute;top:15px;right:20px;background:none;border:none;color:#666;font-size:1.5rem;cursor:pointer">&times;</button>
                
                <h2 style="color:#d4a574;margin-bottom:25px;font-family:Georgia,serif;font-size:1.8rem;text-align:center">Welcome</h2>
                
                <!-- Error Message -->
                <div id="authError" style="display:none;background:rgba(200,100,100,0.2);border:1px solid #c77d8e;padding:12px;border-radius:8px;color:#c77d8e;font-size:14px;margin-bottom:15px"></div>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="form-group" style="margin-bottom:15px">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group" style="margin-bottom:20px">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn-full" id="loginBtn">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Setup Modal (OUTSIDE setupScreen so it shows when setupScreen is hidden) -->
    <div id="profileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;align-items:center;justify-content:center;padding:20px">
        <div style="background:#12121a;border:1px solid #d4a574;border-radius:20px;padding:40px;max-width:450px;width:100%;position:relative">
            <h2 style="color:#d4a574;margin-bottom:10px;font-family:Georgia,serif;font-size:1.8rem">Complete Your Profile</h2>
            <p style="color:#888;margin-bottom:30px;font-size:0.95rem">Set up your territory to get started.</p>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Your ZIP Code</label>
                    <input type="text" id="zipInput" placeholder="e.g. 33301" maxlength="5">
                </div>
                <div class="form-group">
                    <label>Radius</label>
                    <select id="radiusSelect">
                        <option value="25">25 mi</option>
                        <option value="50" selected>50 mi</option>
                        <option value="100">100 mi</option>
                    </select>
                </div>
            </div>
            <div class="territory-info" id="territoryInfo">
                <div class="territory-name" id="territoryName"></div>
                <div class="territory-detail" id="territoryDetail"></div>
            </div>
            <button class="btn-full" id="setupBtn" disabled style="margin-top:20px;border-radius:50px;padding:15px">
                üöÄ Launch Command Center
            </button>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <h1>Personata</h1>
                <div class="badge">
                    üë§ <span id="headerRepName"></span> ‚Ä¢ üìç <span id="headerCity"></span>, <span id="headerTerritory"></span> <span id="headerZip"></span> ‚Ä¢ <span id="headerRadius"></span> mi
                    <a id="changeZipBtn">change</a>
                    <a id="signOutBtn">sign out</a>
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="vendors">üéØ Local Vendors</div>
                <div class="tab" data-tab="groups">FB Groups</div>
                <div class="tab" data-tab="generate">‚ú® Content Creator</div>
                <div class="tab" data-tab="library">Library</div>
                <div class="tab" data-tab="songwriter">üéµ Songwriter Brief</div>
                <div class="tab" data-tab="admin" id="adminTab" style="display:none;background:rgba(200,100,100,0.2);border-color:#c77d8e">üîê Admin</div>
            </div>

            <!-- Admin Panel (hidden by default) -->
            <div class="tab-content" id="admin">
                <h2 class="section-title">üîê Admin Dashboard</h2>
                <div class="info-box" style="border-color:#c77d8e;background:rgba(200,100,100,0.1)">
                    <strong style="color:#c77d8e">Admin Access</strong> ‚Äî View all users, their activity, and vendor contact stats.
                </div>
                
                <div style="margin-bottom:20px">
                    <button class="btn-sm" id="refreshAdminBtn" style="background:#c77d8e">üîÑ Refresh Data</button>
                    <span id="adminLastRefresh" style="color:#666;font-size:12px;margin-left:15px"></span>
                </div>
                
                <!-- Stats Overview -->
                <div class="admin-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px">
                    <div class="stat" style="border-color:#c77d8e">
                        <div class="stat-value" id="adminTotalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat" style="border-color:#8fd4a8">
                        <div class="stat-value" id="adminTotalVendors">0</div>
                        <div class="stat-label">Total Vendors</div>
                    </div>
                    <div class="stat" style="border-color:#7dd3e8">
                        <div class="stat-value" id="adminTotalContacted">0</div>
                        <div class="stat-label">Vendors Contacted</div>
                    </div>
                    <div class="stat" style="border-color:#d4a574">
                        <div class="stat-value" id="adminTotalPosts">0</div>
                        <div class="stat-label">Saved Posts</div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <h3 style="color:#c77d8e;margin-bottom:15px">All Users</h3>
                <div style="overflow-x:auto">
                    <table id="adminUsersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Territory</th>
                                <th>Vendors</th>
                                <th>Contacted</th>
                                <th>Posts</th>
                                <th>Joined</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content active" id="dashboard">
                <div class="featured">
                    <div class="featured-label">‚ú® Today's Post</div>
                    <div style="margin-bottom:15px">
                        <select id="todayPostType" style="padding:8px 12px;background:#0a0a0f;border:1px solid #333;border-radius:6px;color:#fff;font-size:14px">
                            <option value="expert-tip">üí° Expert Tip</option>
                            <option value="client-story">üíí Client Story</option>
                            <option value="poll">üìä Poll</option>
                            <option value="vendor-day">üì£ Vendor Day</option>
                        </select>
                        <button class="btn-sm" id="generateTodayPost" style="margin-left:10px">‚ú® Generate New</button>
                    </div>
                    <div id="todayPostLoading" style="display:none;padding:40px;text-align:center">
                        <div class="spinner" style="margin:0 auto 15px"></div>
                        <div style="color:#888">Generating fresh content...</div>
                    </div>
                    <div id="todayPostContent">
                        <div class="featured-title" id="featuredTitle">Loading...</div>
                        <div class="featured-content" id="featuredContent"></div>
                    </div>
                    <div class="card-actions" style="justify-content:center;margin-bottom:15px">
                        <button class="btn-sm" id="copyFeatured">üìã Copy</button>
                        <button class="btn-sm btn-outline" id="nextFeatured">‚Üí Next</button>
                        <button class="btn-sm btn-outline" id="saveFeatured">+ Save to Library</button>
                    </div>
                    <!-- Quick Post Section -->
                    <div id="quickPostSection" style="border-top:1px solid #333;padding-top:15px;margin-top:10px">
                        <div style="font-size:12px;color:#888;margin-bottom:10px;text-align:center">üì§ Quick Post: Copy & Open</div>
                        <div class="card-actions" style="justify-content:center" id="socialButtons">
                            <button class="btn-sm social-btn" data-platform="facebook" style="background:#1877f2;border:none;padding:10px 16px;font-size:13px;white-space:nowrap">üìã Facebook</button>
                            <button class="btn-sm social-btn" data-platform="instagram" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);border:none;padding:10px 16px;font-size:13px;white-space:nowrap">üìã Instagram</button>
                            <button class="btn-sm social-btn" data-platform="tiktok" style="background:#000;border:1px solid #555;padding:10px 16px;font-size:13px;white-space:nowrap;color:#fff">üìã TikTok</button>
                            <button class="btn-sm social-btn" data-platform="x" style="background:#000;border:1px solid #555;padding:10px 16px;font-size:13px;white-space:nowrap;color:#fff">üìã X</button>
                        </div>
                        <div style="text-align:center;margin-top:10px">
                            <a id="setupSocialsLink" style="color:#888;font-size:12px;cursor:pointer;text-decoration:underline">‚öôÔ∏è Setup your social accounts</a>
                        </div>
                    </div>
                </div>

                <!-- Social Accounts Setup Modal -->
                <div id="socialSetupModal" style="display:none;background:#12121a;border:1px solid #d4a574;border-radius:15px;padding:25px;margin-top:20px">
                    <h3 style="color:#d4a574;margin-bottom:15px">‚öôÔ∏è Social Account Setup</h3>
                    <p style="color:#888;font-size:13px;margin-bottom:20px">Enter your profile URLs. These are saved locally and used to open your accounts for quick posting.</p>
                    <div style="display:grid;gap:15px">
                        <div class="form-group">
                            <label style="color:#1877f2">Facebook Profile/Page URL</label>
                            <input type="text" id="socialFacebook" placeholder="https://facebook.com/yourpage" style="width:100%">
                        </div>
                        <div class="form-group">
                            <label style="color:#e1306c">Instagram Profile URL</label>
                            <input type="text" id="socialInstagram" placeholder="https://instagram.com/yourhandle" style="width:100%">
                        </div>
                        <div class="form-group">
                            <label style="color:#fff">TikTok Profile URL</label>
                            <input type="text" id="socialTiktok" placeholder="https://tiktok.com/@yourhandle" style="width:100%">
                        </div>
                        <div class="form-group">
                            <label style="color:#fff">X (Twitter) Profile URL</label>
                            <input type="text" id="socialX" placeholder="https://x.com/yourhandle" style="width:100%">
                        </div>
                    </div>
                    <div class="card-actions" style="margin-top:20px">
                        <button class="btn-sm" id="saveSocials">üíæ Save Accounts</button>
                        <button class="btn-sm btn-outline" id="closeSocialSetup">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="vendors">
                <h2 class="section-title">Local Wedding Vendors <span class="vendor-count" id="vendorCount">0</span></h2>
                <div class="info-box">
                    <strong>ü§ñ Powered by AI Web Search</strong> ‚Äî Real vendor data verified through web search of Yelp, WeddingWire, The Knot, and Google. 
                    Click a category to search for vendors in your area.
                </div>
                <div class="vendor-controls">
                    <select id="vendorCategory">
                        <option value="">-- Select Category --</option>
                        <option value="wedding planner">Wedding Planners</option>
                        <option value="wedding DJ">Wedding DJs</option>
                        <option value="wedding photographer">Photographers</option>
                        <option value="wedding videographer">Videographers</option>
                        <option value="wedding florist">Florists</option>
                        <option value="wedding venue">Venues</option>
                        <option value="wedding caterer">Caterers</option>
                        <option value="wedding officiant">Officiants</option>
                    </select>
                    <button id="searchVendorsBtn">üîç Search Vendors</button>
                </div>
                <div class="vendor-grid" id="vendorGrid">
                    <p style="color:#666;grid-column:1/-1;text-align:center;padding:40px">
                        Select a category and click "Search Vendors" to find real local wedding professionals
                    </p>
                </div>
            </div>

            <div class="tab-content" id="groups">
                <h2 class="section-title">Facebook Groups</h2>
                <div class="info-box"><strong>Strategy:</strong> Use Expert Tips on regular days. Save Vendor Day posts for promo days.</div>
                <div class="search-links" id="searchLinks"></div>
                <h3 style="color:#d4a574;margin:20px 0 15px">üìç Local Groups</h3>
                <table><thead><tr><th>Group</th><th>Members</th><th>Status</th><th>Notes</th></tr></thead><tbody id="localGroups"></tbody></table>
                <h3 style="color:#d4a574;margin:30px 0 15px">üá∫üá∏ National Groups</h3>
                <table><thead><tr><th>Group</th><th>Members</th><th>Status</th><th>Notes</th></tr></thead><tbody id="nationalGroups"></tbody></table>
                <h3 style="color:#d4a574;margin:30px 0 15px">üéØ Niche Groups</h3>
                <table><thead><tr><th>Group</th><th>Members</th><th>Status</th><th>Notes</th></tr></thead><tbody id="nicheGroups"></tbody></table>
            </div>

            <div class="tab-content" id="generate">
                <!-- Sales Benefits / Pitch Training -->
                <div class="ai-box" style="border-color: #8fd4a8;">
                    <div class="ai-header">
                        <div class="ai-icon" style="background: linear-gradient(135deg, #8fd4a8, #5cb87a);">üéØ</div>
                        <div>
                            <div class="ai-title" style="color: #8fd4a8;">Sales Benefits by Market</div>
                            <div class="ai-subtitle">Learn how to pitch Personata Studios to each vendor type</div>
                        </div>
                    </div>
                    <div class="vendor-controls" style="margin-bottom:15px">
                        <select id="benefitsVendorType">
                            <option value="">-- Select Vendor Type --</option>
                            <option value="Wedding Planner">Wedding Planner</option>
                            <option value="Wedding DJ">Wedding DJ</option>
                            <option value="Wedding Photographer">Photographer</option>
                            <option value="Wedding Videographer">Videographer</option>
                            <option value="Wedding Florist">Florist</option>
                            <option value="Wedding Venue">Venue</option>
                            <option value="Wedding Caterer">Caterer</option>
                            <option value="Wedding Officiant">Officiant</option>
                        </select>
                        <button id="generateBenefitsBtn">üéØ Show Benefits & Pitch</button>
                    </div>
                    <div class="output-box" id="benefitsOutputBox">
                        <p style="text-align:center;color:#666;padding:30px">Select a vendor type to see why they should partner with Personata Studios and how to pitch them</p>
                    </div>
                </div>

                <!-- Email Introduction Generator -->
                <div class="ai-box" style="border-color: #7dd3e8;">
                    <div class="ai-header">
                        <div class="ai-icon" style="background: linear-gradient(135deg, #7dd3e8, #5bb8d4);">üìß</div>
                        <div>
                            <div class="ai-title" style="color: #7dd3e8;">Email Introduction Generator</div>
                            <div class="ai-subtitle">Create partnership outreach emails for wedding vendors</div>
                        </div>
                    </div>
                    <div class="vendor-controls" style="margin-bottom:15px">
                        <select id="emailVendorType">
                            <option value="">-- Select Vendor Type --</option>
                            <option value="Wedding Planner">Wedding Planner</option>
                            <option value="Wedding DJ">Wedding DJ</option>
                            <option value="Wedding Photographer">Photographer</option>
                            <option value="Wedding Videographer">Videographer</option>
                            <option value="Wedding Florist">Florist</option>
                            <option value="Wedding Venue">Venue</option>
                            <option value="Wedding Caterer">Caterer</option>
                            <option value="Wedding Officiant">Officiant</option>
                        </select>
                        <button id="generateEmailBtn">‚úâÔ∏è Generate 3 Email Intros</button>
                    </div>
                    <div class="output-box" id="emailOutputBox">
                        <p style="text-align:center;color:#666;padding:30px">Select a vendor type and click to generate personalized introduction emails</p>
                    </div>
                </div>

                <!-- Social Content Generator -->
                <div class="ai-box">
                    <div class="ai-header">
                        <div class="ai-icon">‚ú®</div>
                        <div>
                            <div class="ai-title">Social Content Generator</div>
                            <div class="ai-subtitle">All content from Personata's expert voice</div>
                        </div>
                    </div>
                    <div class="gen-grid">
                        <div class="gen-btn" data-type="tips"><div class="icon">üí°</div><div class="label">Expert Tips</div><div class="desc">Helpful advice</div></div>
                        <div class="gen-btn" data-type="stories"><div class="icon">üíí</div><div class="label">Client Stories</div><div class="desc">Emotional moments</div></div>
                        <div class="gen-btn" data-type="polls"><div class="icon">üìä</div><div class="label">Polls</div><div class="desc">Engagement</div></div>
                        <div class="gen-btn" data-type="vendor"><div class="icon">üì£</div><div class="label">Vendor Day</div><div class="desc">Promo posts</div></div>
                        <div class="gen-btn" data-type="comments"><div class="icon">üí¨</div><div class="label">Comments</div><div class="desc">Replies</div></div>
                        <div class="gen-btn" data-type="dms"><div class="icon">‚úâÔ∏è</div><div class="label">DMs</div><div class="desc">Outreach</div></div>
                    </div>
                    <div class="output-box" id="outputBox">
                        <p style="text-align:center;color:#666;padding:30px">Click a button to generate content</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="library">
                <h2 class="section-title">Content Library</h2>
                <div class="card-grid" id="libraryGrid"></div>
            </div>

            <!-- Songwriter Brief Builder Tab -->
            <div class="tab-content" id="songwriter">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h2 class="section-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0">üéµ Songwriter Brief Builder</h2>
                    <button class="btn-sm btn-outline" onclick="SW.resetAll()">üîÑ Reset Brief</button>
                </div>
                <div id="sw-wrap" style="max-width:900px;margin:0 auto">
                    <div id="sw-pbar" style="display:flex;align-items:center;margin-bottom:48px;overflow-x:auto;padding-bottom:4px"></div>
                    <div id="sw-main"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">‚úì Copied!</div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBBYH5VkcMNY0nv5V6oeCdj03fRUya5NYE",
            authDomain: "bridal-command-center.firebaseapp.com",
            projectId: "bridal-command-center",
            storageBucket: "bridal-command-center.firebasestorage.app",
            messagingSenderId: "788464324599",
            appId: "1:788464324599:web:36d95b6ab3b22513bd68f2",
            measurementId: "G-JZVB9ZQ0QG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== CONFIG ====================
        const OPENAI_PROXY_URL = 'https://openai-788464324599.us-central1.run.app';

        // ==================== DATA ====================
        const STATES = {AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',CT:'Connecticut',DE:'Delaware',DC:'Washington DC',FL:'Florida',GA:'Georgia',HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'};
        
        const ZIP_STATE = {'005':'PR','006':'PR','007':'PR','008':'PR','009':'PR','010':'MA','011':'MA','012':'MA','013':'MA','014':'MA','015':'MA','016':'MA','017':'MA','018':'MA','019':'MA','020':'MA','021':'MA','022':'MA','023':'MA','024':'MA','025':'MA','026':'MA','027':'MA','028':'RI','029':'RI','030':'NH','031':'NH','032':'NH','033':'NH','034':'NH','035':'NH','036':'NH','037':'NH','038':'NH','039':'ME','040':'ME','041':'ME','042':'ME','043':'ME','044':'ME','045':'ME','046':'ME','047':'ME','048':'ME','049':'ME','050':'VT','051':'VT','052':'VT','053':'VT','054':'VT','056':'VT','057':'VT','058':'VT','059':'VT','060':'CT','061':'CT','062':'CT','063':'CT','064':'CT','065':'CT','066':'CT','067':'CT','068':'CT','069':'CT','070':'NJ','071':'NJ','072':'NJ','073':'NJ','074':'NJ','075':'NJ','076':'NJ','077':'NJ','078':'NJ','079':'NJ','080':'NJ','081':'NJ','082':'NJ','083':'NJ','084':'NJ','085':'NJ','086':'NJ','087':'NJ','088':'NJ','089':'NJ','100':'NY','101':'NY','102':'NY','103':'NY','104':'NY','105':'NY','106':'NY','107':'NY','108':'NY','109':'NY','110':'NY','111':'NY','112':'NY','113':'NY','114':'NY','115':'NY','116':'NY','117':'NY','118':'NY','119':'NY','120':'NY','121':'NY','122':'NY','123':'NY','124':'NY','125':'NY','126':'NY','127':'NY','128':'NY','129':'NY','130':'NY','131':'NY','132':'NY','133':'NY','134':'NY','135':'NY','136':'NY','137':'NY','138':'NY','139':'NY','140':'NY','141':'NY','142':'NY','143':'NY','144':'NY','145':'NY','146':'NY','147':'NY','148':'NY','149':'NY','150':'PA','151':'PA','152':'PA','153':'PA','154':'PA','155':'PA','156':'PA','157':'PA','158':'PA','159':'PA','160':'PA','161':'PA','162':'PA','163':'PA','164':'PA','165':'PA','166':'PA','167':'PA','168':'PA','169':'PA','170':'PA','171':'PA','172':'PA','173':'PA','174':'PA','175':'PA','176':'PA','177':'PA','178':'PA','179':'PA','180':'PA','181':'PA','182':'PA','183':'PA','184':'PA','185':'PA','186':'PA','187':'PA','188':'PA','189':'PA','190':'PA','191':'PA','192':'PA','193':'PA','194':'PA','195':'PA','196':'PA','197':'DE','198':'DE','199':'DE','200':'DC','201':'VA','202':'DC','203':'DC','204':'DC','205':'DC','206':'MD','207':'MD','208':'MD','209':'MD','210':'MD','211':'MD','212':'MD','214':'MD','215':'MD','216':'MD','217':'MD','218':'MD','219':'MD','220':'VA','221':'VA','222':'VA','223':'VA','224':'VA','225':'VA','226':'VA','227':'VA','228':'VA','229':'VA','230':'VA','231':'VA','232':'VA','233':'VA','234':'VA','235':'VA','236':'VA','237':'VA','238':'VA','239':'VA','240':'VA','241':'VA','242':'VA','243':'VA','244':'VA','245':'VA','246':'VA','247':'WV','248':'WV','249':'WV','250':'WV','251':'WV','252':'WV','253':'WV','254':'WV','255':'WV','256':'WV','257':'WV','258':'WV','259':'WV','260':'WV','261':'WV','262':'WV','263':'WV','264':'WV','265':'WV','266':'WV','267':'WV','268':'WV','270':'NC','271':'NC','272':'NC','273':'NC','274':'NC','275':'NC','276':'NC','277':'NC','278':'NC','279':'NC','280':'NC','281':'NC','282':'NC','283':'NC','284':'NC','285':'NC','286':'NC','287':'NC','288':'NC','289':'NC','290':'SC','291':'SC','292':'SC','293':'SC','294':'SC','295':'SC','296':'SC','297':'SC','298':'SC','299':'SC','300':'GA','301':'GA','302':'GA','303':'GA','304':'GA','305':'GA','306':'GA','307':'GA','308':'GA','309':'GA','310':'GA','311':'GA','312':'GA','313':'GA','314':'GA','315':'GA','316':'GA','317':'GA','318':'GA','319':'GA','320':'FL','321':'FL','322':'FL','323':'FL','324':'FL','325':'FL','326':'FL','327':'FL','328':'FL','329':'FL','330':'FL','331':'FL','332':'FL','333':'FL','334':'FL','335':'FL','336':'FL','337':'FL','338':'FL','339':'FL','340':'FL','341':'FL','342':'FL','344':'FL','346':'FL','347':'FL','349':'FL','350':'AL','351':'AL','352':'AL','354':'AL','355':'AL','356':'AL','357':'AL','358':'AL','359':'AL','360':'AL','361':'AL','362':'AL','363':'AL','364':'AL','365':'AL','366':'AL','367':'AL','368':'AL','369':'AL','370':'TN','371':'TN','372':'TN','373':'TN','374':'TN','375':'TN','376':'TN','377':'TN','378':'TN','379':'TN','380':'TN','381':'TN','382':'TN','383':'TN','384':'TN','385':'TN','386':'MS','387':'MS','388':'MS','389':'MS','390':'MS','391':'MS','392':'MS','393':'MS','394':'MS','395':'MS','396':'MS','397':'MS','400':'KY','401':'KY','402':'KY','403':'KY','404':'KY','405':'KY','406':'KY','407':'KY','408':'KY','409':'KY','410':'KY','411':'KY','412':'KY','413':'KY','414':'KY','415':'KY','416':'KY','417':'KY','418':'KY','420':'KY','421':'KY','422':'KY','423':'KY','424':'KY','425':'KY','426':'KY','427':'KY','430':'OH','431':'OH','432':'OH','433':'OH','434':'OH','435':'OH','436':'OH','437':'OH','438':'OH','439':'OH','440':'OH','441':'OH','442':'OH','443':'OH','444':'OH','445':'OH','446':'OH','447':'OH','448':'OH','449':'OH','450':'OH','451':'OH','452':'OH','453':'OH','454':'OH','455':'OH','456':'OH','457':'OH','458':'OH','459':'OH','460':'IN','461':'IN','462':'IN','463':'IN','464':'IN','465':'IN','466':'IN','467':'IN','468':'IN','469':'IN','470':'IN','471':'IN','472':'IN','473':'IN','474':'IN','475':'IN','476':'IN','477':'IN','478':'IN','479':'IN','480':'MI','481':'MI','482':'MI','483':'MI','484':'MI','485':'MI','486':'MI','487':'MI','488':'MI','489':'MI','490':'MI','491':'MI','492':'MI','493':'MI','494':'MI','495':'MI','496':'MI','497':'MI','498':'MI','499':'MI','500':'IA','501':'IA','502':'IA','503':'IA','504':'IA','505':'IA','506':'IA','507':'IA','508':'IA','509':'IA','510':'IA','511':'IA','512':'IA','513':'IA','514':'IA','515':'IA','516':'IA','520':'IA','521':'IA','522':'IA','523':'IA','524':'IA','525':'IA','526':'IA','527':'IA','528':'IA','530':'WI','531':'WI','532':'WI','534':'WI','535':'WI','537':'WI','538':'WI','539':'WI','540':'WI','541':'WI','542':'WI','543':'WI','544':'WI','545':'WI','546':'WI','547':'WI','548':'WI','549':'WI','550':'MN','551':'MN','553':'MN','554':'MN','555':'MN','556':'MN','557':'MN','558':'MN','559':'MN','560':'MN','561':'MN','562':'MN','563':'MN','564':'MN','565':'MN','566':'MN','567':'MN','570':'SD','571':'SD','572':'SD','573':'SD','574':'SD','575':'SD','576':'SD','577':'SD','580':'ND','581':'ND','582':'ND','583':'ND','584':'ND','585':'ND','586':'ND','587':'ND','588':'ND','590':'MT','591':'MT','592':'MT','593':'MT','594':'MT','595':'MT','596':'MT','597':'MT','598':'MT','599':'MT','600':'IL','601':'IL','602':'IL','603':'IL','604':'IL','605':'IL','606':'IL','607':'IL','608':'IL','609':'IL','610':'IL','611':'IL','612':'IL','613':'IL','614':'IL','615':'IL','616':'IL','617':'IL','618':'IL','619':'IL','620':'IL','622':'IL','623':'IL','624':'IL','625':'IL','626':'IL','627':'IL','628':'IL','629':'IL','630':'MO','631':'MO','633':'MO','634':'MO','635':'MO','636':'MO','637':'MO','638':'MO','639':'MO','640':'MO','641':'MO','644':'MO','645':'MO','646':'MO','647':'MO','648':'MO','649':'MO','650':'MO','651':'MO','652':'MO','653':'MO','654':'MO','655':'MO','656':'MO','657':'MO','658':'MO','660':'KS','661':'KS','662':'KS','664':'KS','665':'KS','666':'KS','667':'KS','668':'KS','669':'KS','670':'KS','671':'KS','672':'KS','673':'KS','674':'KS','675':'KS','676':'KS','677':'KS','678':'KS','679':'KS','680':'NE','681':'NE','683':'NE','684':'NE','685':'NE','686':'NE','687':'NE','688':'NE','689':'NE','690':'NE','691':'NE','692':'NE','693':'NE','700':'LA','701':'LA','703':'LA','704':'LA','705':'LA','706':'LA','707':'LA','708':'LA','710':'LA','711':'LA','712':'LA','713':'LA','714':'LA','716':'AR','717':'AR','718':'AR','719':'AR','720':'AR','721':'AR','722':'AR','723':'AR','724':'AR','725':'AR','726':'AR','727':'AR','728':'AR','729':'AR','730':'OK','731':'OK','733':'OK','734':'OK','735':'OK','736':'OK','737':'OK','738':'OK','739':'OK','740':'OK','741':'OK','743':'OK','744':'OK','745':'OK','746':'OK','747':'OK','748':'OK','749':'OK','750':'TX','751':'TX','752':'TX','753':'TX','754':'TX','755':'TX','756':'TX','757':'TX','758':'TX','759':'TX','760':'TX','761':'TX','762':'TX','763':'TX','764':'TX','765':'TX','766':'TX','767':'TX','768':'TX','769':'TX','770':'TX','771':'TX','772':'TX','773':'TX','774':'TX','775':'TX','776':'TX','777':'TX','778':'TX','779':'TX','780':'TX','781':'TX','782':'TX','783':'TX','784':'TX','785':'TX','786':'TX','787':'TX','788':'TX','789':'TX','790':'TX','791':'TX','792':'TX','793':'TX','794':'TX','795':'TX','796':'TX','797':'TX','798':'TX','799':'TX','800':'CO','801':'CO','802':'CO','803':'CO','804':'CO','805':'CO','806':'CO','807':'CO','808':'CO','809':'CO','810':'CO','811':'CO','812':'CO','813':'CO','814':'CO','815':'CO','816':'CO','820':'WY','821':'WY','822':'WY','823':'WY','824':'WY','825':'WY','826':'WY','827':'WY','828':'WY','829':'WY','830':'WY','831':'WY','832':'ID','833':'ID','834':'ID','835':'ID','836':'ID','837':'ID','838':'ID','840':'UT','841':'UT','842':'UT','843':'UT','844':'UT','845':'UT','846':'UT','847':'UT','850':'AZ','851':'AZ','852':'AZ','853':'AZ','855':'AZ','856':'AZ','857':'AZ','858':'AZ','859':'AZ','860':'AZ','863':'AZ','864':'AZ','865':'AZ','870':'NM','871':'NM','872':'NM','873':'NM','874':'NM','875':'NM','877':'NM','878':'NM','879':'NM','880':'NM','881':'NM','882':'NM','883':'NM','884':'NM','889':'NV','890':'NV','891':'NV','893':'NV','894':'NV','895':'NV','897':'NV','898':'NV','900':'CA','901':'CA','902':'CA','903':'CA','904':'CA','905':'CA','906':'CA','907':'CA','908':'CA','910':'CA','911':'CA','912':'CA','913':'CA','914':'CA','915':'CA','916':'CA','917':'CA','918':'CA','920':'CA','921':'CA','922':'CA','923':'CA','924':'CA','925':'CA','926':'CA','927':'CA','928':'CA','930':'CA','931':'CA','932':'CA','933':'CA','934':'CA','935':'CA','936':'CA','937':'CA','938':'CA','939':'CA','940':'CA','941':'CA','942':'CA','943':'CA','944':'CA','945':'CA','946':'CA','947':'CA','948':'CA','949':'CA','950':'CA','951':'CA','952':'CA','953':'CA','954':'CA','955':'CA','956':'CA','957':'CA','958':'CA','959':'CA','960':'CA','961':'CA','967':'HI','968':'HI','970':'OR','971':'OR','972':'OR','973':'OR','974':'OR','975':'OR','976':'OR','977':'OR','978':'OR','979':'OR','980':'WA','981':'WA','982':'WA','983':'WA','984':'WA','985':'WA','986':'WA','988':'WA','989':'WA','990':'WA','991':'WA','992':'WA','993':'WA','994':'WA','995':'AK','996':'AK','997':'AK','998':'AK','999':'AK'};
        
        const NEARBY = {FL:['GA','AL'],GA:['FL','SC','NC','TN','AL'],TX:['OK','AR','LA','NM'],CA:['AZ','NV','OR'],NY:['NJ','CT','PA','MA'],PA:['NJ','NY','OH','DE','MD','WV'],OH:['PA','MI','IN','KY','WV'],IL:['WI','IN','MO','IA'],NC:['SC','GA','TN','VA'],NJ:['NY','PA','DE'],VA:['MD','DC','NC','WV','KY','TN'],MI:['OH','IN','WI'],AZ:['CA','NV','NM','UT'],CO:['NM','UT','WY','NE','KS','OK'],WA:['OR','ID'],MA:['NH','RI','CT','NY','VT'],TN:['KY','VA','NC','GA','AL','MS','AR','MO'],MO:['IL','KS','NE','IA','AR','OK','TN','KY'],IN:['MI','OH','KY','IL'],MD:['PA','DE','VA','WV','DC'],SC:['NC','GA'],AL:['TN','GA','FL','MS'],LA:['TX','AR','MS'],KY:['IN','OH','WV','VA','TN','MO','IL'],NV:['CA','OR','ID','UT','AZ'],OR:['WA','CA','NV','ID'],MN:['WI','IA','SD','ND'],WI:['MN','IA','IL','MI']};

        const GROUPS = {
            national: [
                {name:'Brides on a Budget',members:'100k+',status:'active',notes:'Very active'},
                {name:'2025 Brides',members:'60k+',status:'active',notes:'Year-based'},
                {name:'2026 Brides',members:'40k+',status:'active',notes:'Early planners'},
                {name:'First Dance Songs',members:'18k+',status:'active',notes:'PERFECT for us!'},
                {name:'Wedding Music Ideas',members:'14k+',status:'active',notes:'Directly relevant'},
                {name:'DIY Wedding Ideas',members:'50k+',status:'active',notes:'Creative brides'},
                {name:'Unique Wedding Ideas',members:'40k+',status:'active',notes:'Personalization'},
                {name:'Budget Savvy Brides',members:'45k+',status:'active',notes:'Value-focused'}
            ],
            niche: [
                {name:'Intimate Weddings & Elopements',members:'35k+',status:'active',notes:'Small weddings'},
                {name:'Destination Weddings',members:'40k+',status:'active',notes:'Travel planning'},
                {name:'LGBTQ+ Weddings',members:'28k+',status:'active',notes:'Inclusive'},
                {name:'Black Brides',members:'45k+',status:'active',notes:'Cultural traditions'},
                {name:'Military Brides',members:'25k+',status:'active',notes:'Unique challenges'},
                {name:'Second Wedding Brides',members:'15k+',status:'active',notes:'Meaningful over traditional'},
                {name:'Plus Size Brides',members:'50k+',status:'active',notes:'Body positive'}
            ],
            regional: {
                FL:[{name:'Florida Brides',members:'40k+',status:'active',notes:'Main FL'},{name:'South Florida Brides',members:'30k+',status:'active',notes:'Miami/FtL/WPB'},{name:'Tampa Bay Brides',members:'25k+',status:'active',notes:'Tampa area'},{name:'Orlando Brides',members:'22k+',status:'active',notes:'Central FL'}],
                GA:[{name:'Georgia Brides',members:'35k+',status:'active',notes:'Main GA'},{name:'Atlanta Brides',members:'30k+',status:'active',notes:'ATL metro'}],
                TX:[{name:'Texas Brides',members:'50k+',status:'active',notes:'Main TX'},{name:'Dallas Fort Worth Brides',members:'35k+',status:'active',notes:'DFW'},{name:'Houston Brides',members:'30k+',status:'active',notes:'Houston'},{name:'Austin Brides',members:'25k+',status:'active',notes:'Austin'}],
                CA:[{name:'California Brides',members:'55k+',status:'active',notes:'Main CA'},{name:'Los Angeles Brides',members:'40k+',status:'active',notes:'LA'},{name:'Bay Area Brides',members:'30k+',status:'active',notes:'SF'},{name:'San Diego Brides',members:'25k+',status:'active',notes:'SD'}],
                NY:[{name:'New York Brides',members:'45k+',status:'vendor',notes:'Vendor days'},{name:'NYC Brides',members:'35k+',status:'active',notes:'City'},{name:'Long Island Brides',members:'28k+',status:'active',notes:'LI'}],
                AL:[{name:'Alabama Brides',members:'18k+',status:'active',notes:'Main AL'}]
            }
        };

        const DEFAULT_POSTS = [
            {id:'p1',type:'expert-tip',title:'First Dance Selection',content:"After working with hundreds of couples, here's our #1 advice:\n\nDon't just pick a song you both like. Pick a song that tells YOUR story.\n\nWhat's a song that tells your story? üëá",used:false},
            {id:'p2',type:'client-story',title:'Father-Daughter Moment',content:"One of our favorite moments:\n\nThe bride's father was stoic all day. Then the father-daughter dance started ‚Äî a custom piece mentioning her childhood nickname.\n\nBy the second verse, he completely broke down. That's what personal music can do.",used:false},
            {id:'p3',type:'vendor-day',title:'Personata Introduction',content:"Happy Vendor Day! üëã\n\nWe're Personata Studios ‚Äî we create custom, original songs for weddings.\n\nNot covers. Completely original music about YOUR story.\n\nüéµ Real conversation (not a form)\nüéµ Professional songwriters\nüéµ You own it 100%\n\nQuestions? üíõ",used:false},
            {id:'p4',type:'expert-tip',title:'Wedding Music Timeline',content:"Quick tip from experience:\n\nStart thinking about ceremony and reception music 3+ months out. Custom songs need 4-6 weeks.\n\nWhat most couples forget: the music for walking down the aisle sets the emotional tone for EVERYTHING.",used:false},
            {id:'p5',type:'client-story',title:'The Groom Who Cried',content:"True story from last month:\n\nThe groom wanted to surprise his bride with a custom first dance song. He shared stories from their 7 years together.\n\nWhen she heard it at the reception, she looked at him and said 'How did you...?'\n\nHe was already crying. So was half the room.",used:false}
        ];

        // ==================== NAME ROTATION SYSTEM ====================
        const NAME_POOL = {
            brides: ['Emma', 'Olivia', 'Ava', 'Isabella', 'Sophia', 'Mia', 'Charlotte', 'Amelia', 'Harper', 'Evelyn', 'Abigail', 'Emily', 'Elizabeth', 'Sofia', 'Avery', 'Ella', 'Scarlett', 'Grace', 'Chloe', 'Victoria', 'Riley', 'Aria', 'Lily', 'Aurora', 'Zoey', 'Nora', 'Hannah', 'Hazel', 'Luna', 'Savannah', 'Brooklyn', 'Leah', 'Zoe', 'Stella', 'Maya', 'Audrey', 'Claire', 'Lucy', 'Anna', 'Samantha', 'Caroline', 'Genesis', 'Aaliyah', 'Kennedy', 'Allison', 'Gabriella', 'Ashley', 'Madelyn', 'Addison', 'Natalie', 'Mackenzie', 'Delilah', 'Autumn', 'Valentina', 'Josephine', 'Bella', 'Skylar', 'Julia', 'Sophie', 'Katherine', 'Reagan', 'Madeline', 'Elena', 'Ivy', 'Faith', 'Andrea', 'Naomi', 'Ruby', 'Serenity', 'Peyton', 'Lauren', 'Maria', 'Eva', 'Piper', 'Lydia', 'Taylor', 'Morgan', 'Nicole', 'Jasmine', 'Rachel'],
            grooms: ['Liam', 'Noah', 'Oliver', 'James', 'Elijah', 'William', 'Henry', 'Lucas', 'Benjamin', 'Theodore', 'Jack', 'Levi', 'Alexander', 'Mason', 'Ethan', 'Daniel', 'Jacob', 'Michael', 'Logan', 'Jackson', 'Sebastian', 'Aiden', 'Owen', 'Samuel', 'Ryan', 'Nathan', 'Dylan', 'Caleb', 'Luke', 'Isaac', 'Connor', 'Evan', 'Andrew', 'Joshua', 'Matthew', 'David', 'Joseph', 'Carter', 'Jayden', 'John', 'Gabriel', 'Anthony', 'Christian', 'Hunter', 'Cameron', 'Aaron', 'Thomas', 'Jordan', 'Justin', 'Austin', 'Kevin', 'Brandon', 'Adam', 'Patrick', 'Tyler', 'Jake', 'Marcus', 'Eric', 'Brian', 'Steven', 'Peter', 'Derek', 'Colin', 'Grant', 'Scott', 'Brett', 'Chase', 'Max', 'Cole', 'Trevor', 'Garrett', 'Kyle', 'Blake', 'Sean', 'Dominic', 'Victor', 'Ian', 'Jared', 'Dustin', 'Mitchell'],
            fathers: ['Robert', 'Michael', 'William', 'David', 'Richard', 'Joseph', 'Thomas', 'Charles', 'Christopher', 'Daniel', 'Matthew', 'Anthony', 'Mark', 'Donald', 'Steven', 'Paul', 'Andrew', 'Kenneth', 'George', 'Edward', 'Brian', 'Ronald', 'Timothy', 'Jason', 'Jeffrey', 'Frank', 'Scott', 'Eric', 'Stephen', 'Larry', 'Bruce', 'Dennis', 'Jerry', 'Greg', 'Raymond', 'Keith', 'Douglas', 'Terry', 'Roger', 'Carl', 'Gerald', 'Harold', 'Wayne', 'Arthur', 'Lawrence', 'Albert', 'Eugene', 'Russell', 'Roy', 'Louis'],
            mothers: ['Mary', 'Patricia', 'Jennifer', 'Linda', 'Barbara', 'Elizabeth', 'Susan', 'Jessica', 'Sarah', 'Karen', 'Lisa', 'Nancy', 'Betty', 'Margaret', 'Sandra', 'Ashley', 'Kimberly', 'Emily', 'Donna', 'Michelle', 'Dorothy', 'Carol', 'Amanda', 'Melissa', 'Deborah', 'Stephanie', 'Rebecca', 'Sharon', 'Laura', 'Cynthia', 'Kathleen', 'Amy', 'Angela', 'Shirley', 'Anna', 'Brenda', 'Pamela', 'Emma', 'Nicole', 'Helen', 'Samantha', 'Katherine', 'Christine', 'Debra', 'Rachel', 'Carolyn', 'Janet', 'Catherine', 'Maria', 'Heather']
        };

        function getUsedNames() {
            const stored = localStorage.getItem('personata_used_names');
            if (!stored) return { names: [], timestamp: Date.now() };
            const data = JSON.parse(stored);
            // Clear if older than 14 days
            if (Date.now() - data.timestamp > 14 * 24 * 60 * 60 * 1000) {
                localStorage.removeItem('personata_used_names');
                return { names: [], timestamp: Date.now() };
            }
            return data;
        }

        function saveUsedNames(names) {
            localStorage.setItem('personata_used_names', JSON.stringify({
                names: names,
                timestamp: Date.now()
            }));
        }

        function getRandomName(type) {
            const usedData = getUsedNames();
            const pool = NAME_POOL[type] || NAME_POOL.brides;
            const available = pool.filter(n => !usedData.names.includes(n));
            
            // If we've used all names, reset the pool
            if (available.length === 0) {
                usedData.names = usedData.names.filter(n => !pool.includes(n));
                saveUsedNames(usedData.names);
                return pool[Math.floor(Math.random() * pool.length)];
            }
            
            const name = available[Math.floor(Math.random() * available.length)];
            usedData.names.push(name);
            saveUsedNames(usedData.names);
            return name;
        }

        function getNameInstructions() {
            const bride = getRandomName('brides');
            const groom = getRandomName('grooms');
            const father = getRandomName('fathers');
            const mother = getRandomName('mothers');
            
            return `IMPORTANT: When using names in stories, use ONLY these specific names for this post:
- Bride's name: ${bride}
- Groom's name: ${groom}  
- Father's name: ${father}
- Mother's name: ${mother}
Do NOT use generic names like Sarah, John, Mike, etc. Use the names provided above.`;
        }

        // ==================== STATE ====================
        let currentUser = null;
        let userProfile = null;
        let territory = null;
        let posts = [];
        let vendors = [];
        let socialAccounts = {};

        // ==================== AUTH FUNCTIONS ====================
        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }

        async function handleLogin() {
            hideAuthError();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthError('Please enter email and password');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('authModal').style.display = 'none';
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleRegister() {
            hideAuthError();
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(cred.user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('authModal').style.display = 'none';
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleGoogleSignIn() {
            hideAuthError();
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const userDoc = await db.collection('users').doc(result.user.uid).get();
                if (!userDoc.exists) {
                    await db.collection('users').doc(result.user.uid).set({
                        name: result.user.displayName || 'User',
                        email: result.user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                document.getElementById('authModal').style.display = 'none';
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleSignOut() {
            await auth.signOut();
            location.reload();
        }

        function changeZip() {
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('zipInput').value = territory?.zip || '';
            document.getElementById('radiusSelect').value = territory?.radius || 50;
            if (territory?.zip) {
                document.getElementById('territoryInfo').classList.add('show');
                document.getElementById('territoryName').textContent = territory.stateName || '';
                document.getElementById('territoryDetail').textContent = 'Real vendors via AI web search';
                document.getElementById('setupBtn').disabled = false;
            }
            document.getElementById('profileModal').style.display = 'flex';
        }

        // ==================== ADMIN CONFIG ====================
        // Add your admin email addresses here
        const ADMIN_EMAILS = [
            'david@personatastudios.com'
            // Add more admin emails as needed
        ];

        function isAdmin() {
            return currentUser && ADMIN_EMAILS.includes(currentUser.email);
        }

        // ==================== FIRESTORE ====================
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userProfile = userDoc.data();
                    territory = userProfile.territory || null;
                    
                    // Ensure territory has stateName
                    if (territory && territory.zip && !territory.stateName) {
                        const state = ZIP_STATE[territory.zip.slice(0,3)];
                        territory.state = state;
                        territory.stateName = STATES[state];
                    }
                    
                    posts = userProfile.posts || DEFAULT_POSTS;
                    vendors = []; // Always start fresh ‚Äî vendors are searched live each session
                    socialAccounts = userProfile.socialAccounts || {};
                }
                
                // Show admin tab if user is admin
                if (isAdmin()) {
                    document.getElementById('adminTab').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    territory: territory,
                    posts: posts,
                    socialAccounts: socialAccounts,
                    email: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        async function loadAdminData() {
            if (!isAdmin()) return;
            
            try {
                const snapshot = await db.collection('users').get();
                const users = [];
                let totalVendors = 0;
                let totalContacted = 0;
                let totalPosts = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const userVendors = data.vendors || [];
                    const contacted = userVendors.filter(v => v.contacted).length;
                    const userPosts = (data.posts || []).length;
                    
                    totalVendors += userVendors.length;
                    totalContacted += contacted;
                    totalPosts += userPosts;
                    
                    users.push({
                        id: doc.id,
                        name: data.name || 'Unknown',
                        email: data.email || '',
                        territory: data.territory,
                        vendorCount: userVendors.length,
                        contactedCount: contacted,
                        postCount: userPosts,
                        createdAt: data.createdAt,
                        updatedAt: data.updatedAt
                    });
                });
                
                // Update stats
                document.getElementById('adminTotalUsers').textContent = users.length;
                document.getElementById('adminTotalVendors').textContent = totalVendors;
                document.getElementById('adminTotalContacted').textContent = totalContacted;
                document.getElementById('adminTotalPosts').textContent = totalPosts;
                document.getElementById('adminLastRefresh').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                
                // Render users table
                const tbody = document.getElementById('adminUsersBody');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td style="color:#fff">${esc(u.name)}</td>
                        <td>${esc(u.email)}</td>
                        <td>${u.territory ? `${u.territory.city || ''} ${u.territory.state} ${u.territory.zip}` : '<span style="color:#666">Not set</span>'}</td>
                        <td>${u.vendorCount}</td>
                        <td><span style="color:${u.contactedCount > 0 ? '#8fd4a8' : '#666'}">${u.contactedCount}</span></td>
                        <td>${u.postCount}</td>
                        <td style="font-size:12px">${u.createdAt ? new Date(u.createdAt.toDate()).toLocaleDateString() : '-'}</td>
                        <td style="font-size:12px">${u.updatedAt ? new Date(u.updatedAt.toDate()).toLocaleDateString() : '-'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                toast('Error loading admin data');
            }
        }

        // ==================== AUTH STATE LISTENER ====================
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user ? user.email : 'logged out');
            currentUser = user;
            
            // Hide all screens first
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
            
            if (user) {
                try {
                    await loadUserData();
                    console.log('Territory loaded:', territory);
                    
                    if (territory && territory.zip) {
                        // User has territory, show main app
                        document.getElementById('mainApp').style.display = 'block';
                        await showApp();
                    } else {
                        // User logged in but no territory, show profile setup
                        document.getElementById('profileModal').style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Error in auth handler:', error);
                    document.getElementById('profileModal').style.display = 'flex';
                }
            } else {
                // Not logged in, show setup/landing screen
                document.getElementById('setupScreen').style.display = 'block';
            }
        });

        // ==================== INIT ====================
        function init() {
            // Auth modal controls
            document.getElementById('signInBtn').addEventListener('click', () => {
                document.getElementById('authModal').style.display = 'flex';
            });
            document.getElementById('closeAuthModal').addEventListener('click', () => {
                document.getElementById('authModal').style.display = 'none';
                hideAuthError();
            });
            
            // Auth actions
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('signOutBtn').addEventListener('click', handleSignOut);
            document.getElementById('changeZipBtn').addEventListener('click', changeZip);
            
            // Profile setup
            document.getElementById('zipInput').addEventListener('input', onZipInput);
            document.getElementById('setupBtn').addEventListener('click', onSetup);
            
            // Main app controls
            document.getElementById('copyFeatured').addEventListener('click', copyFeatured);
            document.getElementById('nextFeatured').addEventListener('click', nextFeatured);
            document.getElementById('saveFeatured').addEventListener('click', saveFeatured);
            document.getElementById('generateTodayPost').addEventListener('click', generateTodayPost);
            document.getElementById('searchVendorsBtn').addEventListener('click', () => searchVendors(false));
            document.getElementById('generateEmailBtn').addEventListener('click', generateEmailIntro);
            document.getElementById('generateBenefitsBtn').addEventListener('click', generateBenefits);
            
            // Admin
            document.getElementById('refreshAdminBtn').addEventListener('click', loadAdminData);
            
            // Social account setup
            document.getElementById('setupSocialsLink').addEventListener('click', openSocialSetup);
            document.getElementById('saveSocials').addEventListener('click', saveSocialAccounts);
            document.getElementById('closeSocialSetup').addEventListener('click', closeSocialSetup);
            
            // Social quick post buttons
            document.querySelectorAll('.social-btn').forEach(btn => {
                btn.addEventListener('click', () => quickPost(btn.dataset.platform));
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.dataset.tab) {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                }
            });
            
            document.querySelectorAll('.gen-btn').forEach(btn => {
                btn.addEventListener('click', () => generateContent(btn.dataset.type));
            });
        }

        function onZipInput(e) {
            const zip = e.target.value.replace(/\D/g, '').slice(0,5);
            e.target.value = zip;
            
            if (zip.length === 5) {
                const state = ZIP_STATE[zip.slice(0,3)];
                if (state && STATES[state]) {
                    document.getElementById('territoryName').textContent = STATES[state];
                    document.getElementById('territoryDetail').textContent = 'Real vendors via AI web search';
                    document.getElementById('territoryInfo').classList.add('show');
                    document.getElementById('setupBtn').disabled = false;
                    return;
                }
            }
            document.getElementById('territoryInfo').classList.remove('show');
            document.getElementById('setupBtn').disabled = true;
        }

        async function onSetup() {
            const zip = document.getElementById('zipInput').value;
            const radius = document.getElementById('radiusSelect').value;
            const state = ZIP_STATE[zip.slice(0,3)];
            
            territory = { zip, state, stateName: STATES[state], radius: parseInt(radius) };
            posts = DEFAULT_POSTS.slice();
            vendors = [];
            
            await saveUserData();
            document.getElementById('profileModal').style.display = 'none';
            showApp();
        }

        async function showApp() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('headerTerritory').textContent = territory.state;
            document.getElementById('headerZip').textContent = territory.zip;
            document.getElementById('headerRadius').textContent = territory.radius;
            document.getElementById('headerRepName').textContent = currentUser?.email || 'User';
            
            // Try to get city name
            if (territory.city) {
                document.getElementById('headerCity').textContent = territory.city;
            } else {
                document.getElementById('headerCity').textContent = 'Loading...';
                lookupCity(territory.zip);
            }
            
            render();
        }

        async function lookupCity(zip) {
            try {
                const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                if (response.ok) {
                    const data = await response.json();
                    const city = data.places[0]['place name'];
                    territory.city = city;
                    await saveUserData();
                    document.getElementById('headerCity').textContent = city;
                } else {
                    document.getElementById('headerCity').textContent = territory.stateName;
                }
            } catch (e) {
                document.getElementById('headerCity').textContent = territory.stateName;
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="'+tabId+'"]').classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Load admin data when switching to admin tab
            if (tabId === 'admin' && isAdmin()) {
                loadAdminData();
            }
            
            // Initialize songwriter brief on first visit
            if (tabId === 'songwriter' && !window.swInitialized) {
                window.swInitialized = true;
                SW.init();
            }
        }

        // ==================== RENDER ====================
        function render() {
            renderStats();
            renderLibrary();
            renderGroups();
            renderVendors();
            
            // Auto-generate fresh Expert Tip on first load
            if (!window.initialTipGenerated) {
                window.initialTipGenerated = true;
                document.getElementById('todayPostType').value = 'expert-tip';
                generateTodayPost();
            } else {
                renderFeatured();
            }
        }

        function renderFeatured() {
            if (window.currentTodayPost) {
                document.getElementById('featuredTitle').textContent = window.currentTodayPost.title;
                document.getElementById('featuredContent').textContent = window.currentTodayPost.content;
            } else if (posts.length === 0) {
                document.getElementById('featuredTitle').textContent = 'No posts yet';
                document.getElementById('featuredContent').textContent = 'Generate some content!';
            } else {
                document.getElementById('featuredTitle').textContent = posts[0].title;
                document.getElementById('featuredContent').textContent = posts[0].content;
            }
        }

        function renderStats() {
            const localGroups = buildLocalGroups();
            document.getElementById('vendorCount').textContent = vendors.length;
        }

        function renderLibrary() {
            const grid = document.getElementById('libraryGrid');
            if (posts.length === 0) {
                grid.innerHTML = '<p style="color:#666;grid-column:1/-1;text-align:center;padding:30px">No posts yet. Generate some!</p>';
                return;
            }
            grid.innerHTML = posts.map((p,i) => `
                <div class="card">
                    <div class="card-type">${p.type}</div>
                    <div class="card-title">${esc(p.title)}</div>
                    <div class="card-content">${esc(p.content)}</div>
                    <div class="card-actions">
                        <button class="btn-sm" onclick="copyPost(${i})">üìã Copy</button>
                    </div>
                </div>
            `).join('');
        }

        function buildLocalGroups() {
            let local = (GROUPS.regional[territory.state] || []).slice();
            (NEARBY[territory.state] || []).forEach(ns => {
                (GROUPS.regional[ns] || []).forEach(g => {
                    if (!local.find(x => x.name === g.name)) {
                        local.push({...g, notes: g.notes + ' (nearby)'});
                    }
                });
            });
            return local;
        }

        function renderGroups() {
            const local = buildLocalGroups();
            const state = territory.stateName;
            const searches = [state + ' brides 2025', state + ' wedding planning', state + ' engaged'];
            document.getElementById('searchLinks').innerHTML = searches.map(q => 
                `<a class="search-link" href="https://facebook.com/search/groups?q=${encodeURIComponent(q)}" target="_blank">üîç ${q}</a>`
            ).join('');
            
            document.getElementById('localGroups').innerHTML = local.length ? local.map(g => groupRow(g)).join('') : '<tr><td colspan="4" style="color:#666">No local groups found</td></tr>';
            document.getElementById('nationalGroups').innerHTML = GROUPS.national.map(g => groupRow(g)).join('');
            document.getElementById('nicheGroups').innerHTML = GROUPS.niche.map(g => groupRow(g)).join('');
        }

        function groupRow(g) {
            const statusClass = g.status === 'active' ? 'status-ok' : 'status-vendor';
            const statusText = g.status === 'active' ? 'OK' : 'Vendor Days';
            const fbSearchUrl = `https://www.facebook.com/search/groups?q=${encodeURIComponent(g.name)}`;
            return `<tr>
                <td><a href="${fbSearchUrl}" target="_blank" style="color:#7dd3e8;text-decoration:none">${esc(g.name)}</a></td>
                <td>${g.members}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>${esc(g.notes)}</td>
            </tr>`;
        }

        function renderVendors() {
            const grid = document.getElementById('vendorGrid');
            if (vendors.length === 0) {
                grid.innerHTML = '<p style="color:#666;grid-column:1/-1;text-align:center;padding:40px">Select a category and click "Search Vendors" to find real local wedding professionals</p>';
                return;
            }
            grid.innerHTML = vendors.map((v, i) => `
                <div class="vendor-card ${v.contacted ? 'vendor-contacted' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                        <div class="vendor-type">${esc(v.type || v.category)}</div>
                        <label class="contact-checkbox" title="${v.contacted ? 'Contacted on ' + new Date(v.contactedAt).toLocaleDateString() : 'Mark as contacted'}">
                            <input type="checkbox" ${v.contacted ? 'checked' : ''} onchange="toggleContacted(${i})">
                            <span class="checkmark"></span>
                            <span class="contact-label">${v.contacted ? '‚úì Contacted' : 'Contacted?'}</span>
                        </label>
                    </div>
                    <div class="vendor-name">${esc(v.name)}</div>
                    <div class="vendor-address">${esc(v.address || '')}</div>
                    ${v.phone ? `<div class="vendor-phone">üìû <a href="tel:${v.phone}" style="color:#7dd3e8">${v.phone}</a></div>` : ''}
                    ${v.email ? `<div class="vendor-phone">‚úâÔ∏è <a href="mailto:${v.email}" style="color:#7dd3e8">${v.email}</a></div>` : ''}
                    ${v.contacted ? `<div class="contacted-date">üìÖ Contacted: ${new Date(v.contactedAt).toLocaleDateString()}</div>` : ''}
                    <div class="vendor-actions">
                        <a class="vendor-link" href="https://www.google.com/search?q=${encodeURIComponent(v.name + ' ' + (v.address || territory.stateName))}" target="_blank">üîç Google</a>
                        ${v.website ? `<a class="vendor-link" href="${v.website}" target="_blank">üåê Website</a>` : ''}
                        ${v.email ? `<a class="vendor-link" href="mailto:${v.email}">‚úâÔ∏è Email</a>` : ''}
                    </div>
                </div>
            `).join('') + (currentSearchCategory ? `
                <div style="grid-column:1/-1;text-align:center;padding:30px 0" id="loadMoreBtn">
                    <button onclick="searchVendors(true)" style="padding:16px 48px;background:linear-gradient(135deg,#d4a574,#c49464);color:#0a0a12;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;letter-spacing:1px;transition:all .3s">üîç Load More</button>
                    <p style="color:#666;font-size:12px;margin-top:10px">${vendors.filter(v=>v.category===currentSearchCategory).length} ${currentSearchCategory}s loaded</p>
                </div>
            ` : '');
        }

        async function toggleContacted(index) {
            vendors[index].contacted = !vendors[index].contacted;
            if (vendors[index].contacted) {
                vendors[index].contactedAt = new Date().toISOString();
            } else {
                delete vendors[index].contactedAt;
            }
            await saveUserData();
            renderVendors();
            toast(vendors[index].contacted ? 'Marked as contacted!' : 'Unmarked');
        }

        // ==================== VENDOR SEARCH (with Web Search) ====================
        let currentSearchCategory = '';
        
        async function searchVendors(loadMore = false) {
            const category = loadMore ? currentSearchCategory : document.getElementById('vendorCategory').value;
            if (!category) {
                toast('Please select a category first');
                return;
            }
            currentSearchCategory = category;
            
            const grid = document.getElementById('vendorGrid');
            
            if (!loadMore) {
                vendors = vendors.filter(v => v.category !== category);
                grid.innerHTML = `
                    <div class="loading" style="grid-column:1/-1">
                        <div class="spinner"></div>
                        <div class="loading-text">Searching for ${category}s...</div>
                        <div class="loading-sub">Finding vendors with contact info (this may take a moment)...</div>
                    </div>
                `;
            } else {
                const loadBtn = document.getElementById('loadMoreBtn');
                if (loadBtn) loadBtn.outerHTML = `
                    <div class="loading" style="grid-column:1/-1" id="loadMoreLoading">
                        <div class="spinner"></div>
                        <div class="loading-text">Loading more ${category}s...</div>
                    </div>
                `;
            }
            
            const existingNames = vendors.filter(v => v.category === category).map(v => v.name);
            const excludeText = existingNames.length > 0 ? `\nDo NOT include these vendors I already have: ${existingNames.join(', ')}\n` : '';
            
            const prompt = `Find ${category}s near ${territory.zip} (${territory.stateName}) within ${territory.radius} miles.
${excludeText}
For each vendor provide name, address (city, state), phone, website URL, and email.
Search WeddingWire, The Knot, Yelp, Google for real vendors.
Return as JSON array: [{"name":"...","address":"...","phone":"...","website":"...","email":"..."}]
Find at least 30 vendors. Use "" for unknown fields.`;

            let newVendors = null;
            
            // Try search model first
            try {
                newVendors = await callVendorAPI('gpt-4o-search-preview', prompt, true);
            } catch (e) {
                console.log('Search model failed, trying fallback:', e.message);
            }
            
            // Fallback to gpt-4o-mini
            if (!newVendors) {
                try {
                    newVendors = await callVendorAPI('gpt-4o-mini', prompt, false);
                } catch (e) {
                    console.log('Fallback also failed:', e.message);
                }
            }
            
            if (!newVendors || newVendors.length === 0) {
                if (!loadMore) {
                    grid.innerHTML = `<div class="error-box" style="grid-column:1/-1"><strong>No vendors found.</strong> Try a different category or expand your search radius.</div>`;
                }
                return;
            }
            
            newVendors = newVendors.map(v => ({
                ...v,
                type: category.replace('wedding ', ''),
                category: category
            }));
            
            const existingSet = new Set(vendors.map(v => v.name.toLowerCase()));
            let added = 0;
            newVendors.forEach(v => {
                if (v.name && !existingSet.has(v.name.toLowerCase())) {
                    vendors.push(v);
                    existingSet.add(v.name.toLowerCase());
                    added++;
                }
            });
            
            renderVendors();
            renderStats();
            
            const total = vendors.filter(v => v.category === category).length;
            toast(`Found ${added} ${category}s (${total} total)`);
            
            // Email enrichment for vendors missing email
            const needEmail = vendors.filter(v => v.category === category && !v.email);
            if (needEmail.length > 0) {
                toast('Searching for emails...');
                await findVendorEmails(needEmail);
            }
        }
        
        // Unified API call with robust JSON parsing
        async function callVendorAPI(model, prompt, useSearch) {
            const body = {
                model: model,
                messages: [
                    {role: 'system', content: 'Find real wedding vendors. Return ONLY a JSON array. No markdown, no commentary, no explanation ‚Äî just the JSON array.'},
                    {role: 'user', content: prompt}
                ],
                max_tokens: 8000
            };
            if (useSearch) {
                body.web_search_options = { search_context_size: 'high' };
            } else {
                body.temperature = 0.1;
            }
            
            const response = await fetch(OPENAI_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `API error ${response.status}`);
            }
            
            const data = await response.json();
            let content = data.choices?.[0]?.message?.content || '';
            
            return parseVendorJSON(content);
        }
        
        // Robust JSON parser that handles messy AI responses
        function parseVendorJSON(content) {
            content = content.trim();
            
            // Strip markdown code blocks
            content = content.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
            
            // Try direct parse first
            try {
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) return parsed;
            } catch (e) {}
            
            // Try extracting JSON array from surrounding text
            const arrayMatch = content.match(/\[\s*\{[\s\S]*\}\s*\]/);
            if (arrayMatch) {
                try {
                    const parsed = JSON.parse(arrayMatch[0]);
                    if (Array.isArray(parsed)) return parsed;
                } catch (e) {}
            }
            
            // Try fixing common issues: trailing commas, missing brackets
            let cleaned = content;
            // Find the first [ and last ]
            const firstBracket = cleaned.indexOf('[');
            const lastBracket = cleaned.lastIndexOf(']');
            if (firstBracket !== -1 && lastBracket > firstBracket) {
                cleaned = cleaned.substring(firstBracket, lastBracket + 1);
                // Remove trailing commas before ]
                cleaned = cleaned.replace(/,\s*\]/g, ']').replace(/,\s*\}/g, '}');
                try {
                    const parsed = JSON.parse(cleaned);
                    if (Array.isArray(parsed)) return parsed;
                } catch (e) {}
            }
            
            console.error('Could not parse vendor response:', content.substring(0, 500));
            throw new Error('Failed to parse vendor data');
        }

        // Focused email finder ‚Äî processes vendors in batches
        async function findVendorEmails(vendorList) {
            const batchSize = 10;
            let totalFound = 0;
            
            for (let i = 0; i < vendorList.length; i += batchSize) {
                const batch = vendorList.slice(i, i + batchSize);
                const vendorLines = batch.map(v => 
                    `${v.name} | ${v.address || ''} | website: ${v.website || 'unknown'}`
                ).join('\n');
                
                try {
                    const response = await fetch(OPENAI_PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'gpt-4o-search-preview',
                            web_search_options: { search_context_size: 'high' },
                            messages: [
                                {role: 'system', content: 'You find email addresses for wedding vendors by searching the web. For each vendor, search their website contact/about page, WeddingWire profile, The Knot profile, Yelp page, and Facebook page. Return valid JSON only.'},
                                {role: 'user', content: `Find the contact email address for each of these wedding vendors. Search their websites and online profiles.\n\n${vendorLines}\n\nReturn JSON array:\n[{"name":"exact name","email":"found@email.com"}]\n\nOnly include vendors where you found an email. Return [] if none found.`}
                            ],
                            max_tokens: 2000
                        })
                    });
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    let content = data.choices[0].message.content.trim();
                    content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const jsonMatch = content.match(/\[[\s\S]*\]/);
                    if (jsonMatch) content = jsonMatch[0];
                    
                    const results = JSON.parse(content);
                    if (Array.isArray(results)) {
                        results.forEach(r => {
                            if (r.email && r.email.includes('@')) {
                                const v = vendors.find(v => v.name.toLowerCase() === r.name.toLowerCase());
                                if (v && !v.email) {
                                    v.email = r.email;
                                    totalFound++;
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error('Email batch error:', e);
                }
            }
            
            if (totalFound > 0) {
                await saveUserData();
                renderVendors();
            }
            toast(totalFound > 0 ? `Found ${totalFound} email${totalFound > 1 ? 's' : ''}!` : 'Email search complete');
        }

        // ==================== SOCIAL ACCOUNTS ====================
        function openSocialSetup() {
            document.getElementById('socialSetupModal').style.display = 'block';
            // Load saved values
            document.getElementById('socialFacebook').value = socialAccounts.facebook || '';
            document.getElementById('socialInstagram').value = socialAccounts.instagram || '';
            document.getElementById('socialTiktok').value = socialAccounts.tiktok || '';
            document.getElementById('socialX').value = socialAccounts.x || '';
        }

        function closeSocialSetup() {
            document.getElementById('socialSetupModal').style.display = 'none';
        }

        async function saveSocialAccounts() {
            socialAccounts = {
                facebook: document.getElementById('socialFacebook').value.trim(),
                instagram: document.getElementById('socialInstagram').value.trim(),
                tiktok: document.getElementById('socialTiktok').value.trim(),
                x: document.getElementById('socialX').value.trim()
            };
            await saveUserData();
            closeSocialSetup();
            toast('Social accounts saved!');
        }

        function quickPost(platform) {
            // First copy the content
            let content = '';
            if (window.currentTodayPost) {
                content = window.currentTodayPost.content;
            } else if (posts.length > 0) {
                content = posts[0].content;
            }
            
            if (!content) {
                toast('No post to copy');
                return;
            }
            
            navigator.clipboard.writeText(content);
            
            // Determine URL to open
            let url = '';
            const savedUrl = socialAccounts[platform];
            
            if (savedUrl) {
                // Use their saved profile URL
                url = savedUrl;
            } else {
                // Default posting URLs
                const defaults = {
                    facebook: 'https://www.facebook.com/',
                    instagram: 'https://www.instagram.com/',
                    tiktok: 'https://www.tiktok.com/upload',
                    x: 'https://x.com/compose/tweet'
                };
                url = defaults[platform];
            }
            
            // Open in new tab
            window.open(url, '_blank');
            toast('Copied! Opening ' + platform.charAt(0).toUpperCase() + platform.slice(1) + '...');
        }

        // ==================== ACTIONS ====================
        function copyFeatured() {
            if (window.currentTodayPost) {
                navigator.clipboard.writeText(window.currentTodayPost.content);
                toast('Copied!');
            } else if (posts.length > 0) {
                navigator.clipboard.writeText(posts[0].content);
                toast('Copied!');
            }
        }

        async function nextFeatured() {
            window.currentTodayPost = null; // Clear generated post
            if (posts.length > 1) {
                posts.push(posts.shift());
                await saveUserData();
                renderFeatured();
            }
        }

        async function saveFeatured() {
            if (window.currentTodayPost) {
                posts.unshift(window.currentTodayPost);
                await saveUserData();
                window.currentTodayPost = null;
                renderLibrary();
                renderStats();
                toast('Saved to library!');
            } else {
                toast('Generate a new post first');
            }
        }

        async function generateTodayPost() {
            const postType = document.getElementById('todayPostType').value;
            
            document.getElementById('todayPostLoading').style.display = 'block';
            document.getElementById('todayPostContent').style.display = 'none';
            
            const nameInstructions = getNameInstructions();
            
            const prompts = {
                'expert-tip': 'Create 1 Expert Tip about wedding music, first dances, or making weddings more personal and meaningful. Make it helpful and shareable.',
                'client-story': `Create 1 short Client Story (anonymized) about an emotional moment involving custom wedding music. Make it touching and authentic.\n\n${nameInstructions}`,
                'poll': 'Create 1 engaging Poll Question about wedding music preferences, first dance choices, or wedding personalization. Include 3-4 answer options.',
                'vendor-day': 'Create 1 Vendor Day promotional post introducing Personata Studios custom wedding songs. Highlight the conversation-driven process and that couples own 100% of their song.'
            };

            try {
                const response = await fetch(OPENAI_PROXY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                        
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        max_tokens: 1000,
                        messages: [
                            { role: 'system', content: 'You create social media content for Personata Studios, a company that creates custom original wedding songs through real conversations (not forms or AI). Write as the vendor. Be warm, authentic, and engaging. Keep posts concise and perfect for Facebook groups. When telling client stories, ALWAYS use the specific names provided - never default to common names like Sarah, John, Mike, or Emily.' },
                            { role: 'user', content: prompts[postType] }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API error');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                
                // Store the generated post
                window.currentTodayPost = {
                    id: 'gen_' + Date.now(),
                    type: postType,
                    title: postType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    content: content,
                    used: false
                };
                
                // Display it
                document.getElementById('featuredTitle').textContent = window.currentTodayPost.title;
                document.getElementById('featuredContent').textContent = content;
                
            } catch (e) {
                document.getElementById('featuredTitle').textContent = 'Error';
                document.getElementById('featuredContent').textContent = e.message;
            }
            
            document.getElementById('todayPostLoading').style.display = 'none';
            document.getElementById('todayPostContent').style.display = 'block';
        }

        function copyPost(i) {
            navigator.clipboard.writeText(posts[i].content);
            toast('Copied!');
        }

        // ==================== EMAIL INTRODUCTION GENERATOR ====================
        async function generateEmailIntro() {
            const vendorType = document.getElementById('emailVendorType').value;
            if (!vendorType) {
                toast('Please select a vendor type first');
                return;
            }
            
            const box = document.getElementById('emailOutputBox');
            box.innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Generating email introductions...</div></div>';
            
            const prompt = `Create 3 different email introductions from Personata Studios to a ${vendorType}.

Personata Studios creates custom, original wedding songs through a conversation-driven process (not forms or AI-generated). We're looking to partner with wedding vendors who can refer their clients to us.

Create 3 DIFFERENT approaches:
1. A warm, relationship-focused introduction
2. A value-proposition focused introduction (what's in it for them)
3. A brief, get-to-the-point introduction

Each email should:
- Have a compelling subject line
- Be professional but warm
- Mention the referral partnership opportunity
- Mention that we pay generous referral commissions for every client they send our way
- Be concise (under 150 words each)
- Include a clear call to action
- IMPORTANT: Always mention they can hear song samples at https://personata.com

Format each email as:
STYLE: [style name]
SUBJECT: [subject line]
BODY: [email body]
---`;

            try {
                const response = await fetch(OPENAI_PROXY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                        
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        max_tokens: 2500,
                        messages: [
                            { role: 'system', content: 'You write professional business development emails for Personata Studios, a company that creates custom original wedding songs. Be warm, professional, and concise.' },
                            { role: 'user', content: prompt }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API error');
                }
                const data = await response.json();
                const text = data.choices[0].message.content;
                displayEmailIntros(text, vendorType);
            } catch (e) {
                box.innerHTML = `<div class="error-box">Error: ${e.message}</div>`;
            }
        }

        function displayEmailIntros(text, vendorType) {
            const emails = [];
            text.split(/\n---\n?/).forEach(section => {
                const style = (section.match(/STYLE:\s*(.+)/i) || [])[1] || 'Email';
                const subject = (section.match(/SUBJECT:\s*(.+)/i) || [])[1] || '';
                const body = (section.match(/BODY:\s*([\s\S]+?)(?=\nSTYLE:|\n---|$)/i) || [])[1];
                if (body && body.trim().length > 20) {
                    emails.push({ style: style.trim(), subject: subject.trim(), body: body.trim() });
                }
            });
            
            if (emails.length === 0) {
                document.getElementById('emailOutputBox').innerHTML = '<p style="color:#666;text-align:center;padding:30px">No emails generated. Please try again.</p>';
                return;
            }
            
            document.getElementById('emailOutputBox').innerHTML = `
                <div style="margin-bottom:15px;color:#7dd3e8;font-size:14px">üìß ${emails.length} email options for <strong>${vendorType}</strong></div>
                ${emails.map((email, i) => `
                    <div class="output-item" style="border-color:#7dd3e8;">
                        <div class="output-type" style="color:#7dd3e8">${esc(email.style)}</div>
                        <div style="background:#0a0a0f;padding:10px;border-radius:6px;margin-bottom:10px">
                            <div style="color:#888;font-size:12px;margin-bottom:5px">SUBJECT:</div>
                            <div style="color:#fff;font-weight:600">${esc(email.subject)}</div>
                        </div>
                        <div class="output-content">${esc(email.body)}</div>
                        <div class="card-actions">
                            <button class="btn-sm" onclick="copyEmail(${i})">üìã Copy Email</button>
                            <button class="btn-sm btn-outline" onclick="copyEmailWithSubject(${i})">üìã Copy with Subject</button>
                        </div>
                    </div>
                `).join('')}
            `;
            
            window.generatedEmails = emails;
        }

        function copyEmail(i) {
            navigator.clipboard.writeText(window.generatedEmails[i].body);
            toast('Email copied!');
        }

        function copyEmailWithSubject(i) {
            const email = window.generatedEmails[i];
            navigator.clipboard.writeText(`Subject: ${email.subject}\n\n${email.body}`);
            toast('Email with subject copied!');
        }

        // ==================== SALES BENEFITS GENERATOR ====================
        async function generateBenefits() {
            const vendorType = document.getElementById('benefitsVendorType').value;
            if (!vendorType) {
                toast('Please select a vendor type first');
                return;
            }
            
            const box = document.getElementById('benefitsOutputBox');
            box.innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Generating sales pitch benefits...</div></div>';
            
            const prompt = `You are training a sales rep on how to pitch Personata Studios to a ${vendorType}.

Personata Studios creates custom, original wedding songs through a conversation-driven process (not forms or AI-generated). We partner with wedding vendors who refer their clients to us and earn referral commissions.

Create a comprehensive sales training guide specifically for pitching to a ${vendorType}. Include:

1. WHY THEY SHOULD CARE (3-4 specific benefits for a ${vendorType})
- How does partnering with Personata Studios help THEIR business?
- What problems does it solve for their clients?
- How does it make them look good?

2. THEIR CLIENTS' PAIN POINTS
- What do their wedding clients struggle with related to music/personalization?
- How can a custom song solve these problems?

3. KEY TALKING POINTS (5-6 bullet points)
- Specific things to say when pitching to a ${vendorType}
- How to tie custom songs to what they already do

4. OBJECTION HANDLERS
- Common objections a ${vendorType} might have and how to respond

5. THE ASK
- How to close the conversation and get them to agree to a partnership

Format clearly with headers and bullet points for easy reading.`;

            try {
                const response = await fetch(OPENAI_PROXY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                        
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        max_tokens: 2500,
                        messages: [
                            { role: 'system', content: 'You are a sales trainer helping reps learn how to pitch Personata Studios custom wedding songs to wedding industry vendors. Be specific, practical, and actionable. Use clear formatting with headers and bullet points.' },
                            { role: 'user', content: prompt }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API error');
                }
                const data = await response.json();
                const text = data.choices[0].message.content;
                displayBenefits(text, vendorType);
            } catch (e) {
                box.innerHTML = `<div class="error-box">Error: ${e.message}</div>`;
            }
        }

        function displayBenefits(text, vendorType) {
            // Convert markdown-style formatting to HTML
            let html = text
                .replace(/^### (.+)$/gm, '<h4 style="color:#8fd4a8;margin:20px 0 10px;font-size:1.1rem">$1</h4>')
                .replace(/^## (.+)$/gm, '<h3 style="color:#8fd4a8;margin:25px 0 15px;font-size:1.2rem">$1</h3>')
                .replace(/^# (.+)$/gm, '<h3 style="color:#8fd4a8;margin:25px 0 15px;font-size:1.3rem">$1</h3>')
                .replace(/^\*\*(.+?)\*\*$/gm, '<strong style="color:#fff">$1</strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.+)$/gm, '<li style="margin:8px 0;color:#ccc">$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li style="margin:8px 0;color:#ccc"><strong>$1.</strong> $2</li>')
                .replace(/\n\n/g, '</p><p style="margin:10px 0;color:#888">')
                .replace(/\n/g, '<br>');
            
            // Wrap lists
            html = html.replace(/(<li[^>]*>.*?<\/li>)+/g, '<ul style="margin:10px 0 15px 20px;list-style:disc">$&</ul>');
            
            document.getElementById('benefitsOutputBox').innerHTML = `
                <div style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #333">
                    <span style="color:#8fd4a8;font-size:16px;font-weight:600">üéØ Sales Pitch Guide: ${vendorType}</span>
                    <button class="btn-sm" onclick="copyBenefits()" style="float:right">üìã Copy All</button>
                </div>
                <div style="color:#888;line-height:1.7" id="benefitsContent">
                    ${html}
                </div>
            `;
            
            window.generatedBenefits = text;
        }

        function copyBenefits() {
            navigator.clipboard.writeText(window.generatedBenefits);
            toast('Benefits copied!');
        }

        // ==================== AI CONTENT GENERATION ====================
        async function generateContent(type) {
            const box = document.getElementById('outputBox');
            box.innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Generating content...</div></div>';
            
            const nameInstructions = getNameInstructions();
            
            const prompts = {
                tips: 'Create 3 Expert Tips about wedding music',
                stories: `Create 3 Client Stories (anonymized emotional moments). Each story should use DIFFERENT names.\n\n${nameInstructions}\n\nFor the second story, use: Bride: ${getRandomName('brides')}, Groom: ${getRandomName('grooms')}\nFor the third story, use: Bride: ${getRandomName('brides')}, Groom: ${getRandomName('grooms')}`,
                polls: 'Create 3 Poll Questions for engagement',
                vendor: 'Create 2 Vendor Day promotional posts',
                comments: 'Create 4 Comment reply templates',
                dms: 'Create 3 DM outreach templates'
            };

            try {
                const response = await fetch(OPENAI_PROXY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                        
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        max_tokens: 3000,
                        messages: [
                            { role: 'system', content: 'You create content for Personata Studios (custom wedding songs). Write as the VENDOR, not as a bride. Professional but warm. When telling client stories, ALWAYS use the specific names provided in the prompt - never default to common names like Sarah, John, Mike, or Emily. Format each piece as:\nTYPE: [type]\nTITLE: [title]\nCONTENT: [content]\n---' },
                            { role: 'user', content: prompts[type] }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API error');
                }
                const data = await response.json();
                const text = data.choices[0].message.content;
                displayGenerated(text);
            } catch (e) {
                box.innerHTML = `<div class="error-box">Error: ${e.message}</div>`;
            }
        }

        function displayGenerated(text) {
            const items = [];
            text.split(/\n---\n?/).forEach(section => {
                const type = (section.match(/TYPE:\s*(.+)/i) || [])[1] || 'Post';
                const title = (section.match(/TITLE:\s*(.+)/i) || [])[1] || 'Untitled';
                const content = (section.match(/CONTENT:\s*([\s\S]+?)(?=\nTYPE:|\n---|$)/i) || [])[1];
                if (content && content.trim().length > 20) {
                    items.push({ type: type.trim(), title: title.trim(), content: content.trim() });
                }
            });
            
            if (items.length === 0) {
                document.getElementById('outputBox').innerHTML = '<p style="color:#666;text-align:center;padding:30px">No content generated</p>';
                return;
            }
            
            document.getElementById('outputBox').innerHTML = items.map((item, i) => `
                <div class="output-item">
                    <div class="output-type">${esc(item.type)}</div>
                    <div class="output-content">${esc(item.content)}</div>
                    <div class="card-actions">
                        <button class="btn-sm" onclick="copyGenerated(${i})">üìã Copy</button>
                        <button class="btn-sm btn-outline" onclick="saveGenerated(${i})">+ Save</button>
                    </div>
                </div>
            `).join('');
            
            window.generatedItems = items;
        }

        function copyGenerated(i) {
            navigator.clipboard.writeText(window.generatedItems[i].content);
            toast('Copied!');
        }

        async function saveGenerated(i) {
            const item = window.generatedItems[i];
            posts.push({
                id: 'g' + Date.now(),
                type: item.type.toLowerCase().includes('tip') ? 'expert-tip' : item.type.toLowerCase().includes('story') ? 'client-story' : 'vendor-day',
                title: item.title,
                content: item.content,
                used: false
            });
            await saveUserData();
            renderLibrary();
            renderStats();
            toast('Saved to library!');
        }

        // ==================== UTILS ====================
        function esc(str) {
            const div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // ==================== SONGWRITER BRIEF BUILDER ====================
        const SW = (function() {
            let SC = 0, CV = 'setup', songs = [], proj = {projectName:'',collectionType:'Demo Collection',eventDate:'',creativeDirector:''};

            function ES(){return{songType:'',songTypeCustom:'',songTitle:'',songSubtitle:'',songStructure:'Standard (Verse/Chorus)',songTone:'',customerName:'',customerRelationship:'',singerName:'',singerAge:'',singingTo:'',singerWho:'',singerBackground:'',singerPersonality:'',singerEmotional:'',singerVoice:'',points:Array.from({length:10},()=>({title:'',body:''})),singerQuote:''}}

            function SL(){const s=['setup','project'];for(let i=1;i<=SC;i++)s.push('info-'+i,'voice-'+i,'points-'+i);s.push('preview');return s}
            function navigateTo(v){saveDOM();CV=v;render();window.scrollTo({top:0,behavior:'smooth'})}
            function goNext(){const s=SL(),i=s.indexOf(CV);if(i<s.length-1)navigateTo(s[i+1])}
            function goPrev(){const s=SL(),i=s.indexOf(CV);if(i>0)navigateTo(s[i-1])}

            function saveDOM(){
                if(CV==='project'){const g=id=>(document.getElementById(id)||{}).value||'';proj.projectName=g('sw-pn').trim();proj.collectionType=g('sw-ct');proj.eventDate=g('sw-ed').trim();proj.creativeDirector=g('sw-cd').trim();return}
                const m=CV.match(/^(info|voice|points)-(\d+)$/);if(!m)return;
                const x=+m[2]-1,s=songs[x],P='sw-s'+x+'-',g=id=>(document.getElementById(P+id)||{}).value||'';
                if(m[1]==='info'){s.songType=g('st');s.songTypeCustom=g('stc').trim();s.songTitle=g('tt').trim();s.songSubtitle=g('sub').trim();s.songStructure=g('str');s.songTone=g('tn').trim()}
                else if(m[1]==='voice'){s.customerName=g('cn').trim();s.customerRelationship=g('cr').trim();s.singerName=g('sn').trim();s.singerAge=g('sa').trim();s.singingTo=g('sto').trim();s.singerWho=g('sw').trim();s.singerBackground=g('sb').trim();s.singerPersonality=g('sp').trim();s.singerEmotional=g('se').trim();s.singerVoice=g('sv').trim()}
                else{for(let i=0;i<10;i++){s.points[i].title=g('p'+i+'t').trim();s.points[i].body=g('p'+i+'b').trim()}s.singerQuote=g('q').trim()}
            }

            function render(){renderPB();const el=document.getElementById('sw-main');
                if(CV==='setup')el.innerHTML=hSetup();
                else if(CV==='project')el.innerHTML=hProj();
                else if(CV==='preview')el.innerHTML=hPrev();
                else{const m=CV.match(/^(info|voice|points)-(\d+)$/);if(m){const x=+m[2]-1;el.innerHTML=m[1]==='info'?hInfo(x):m[1]==='voice'?hVoice(x):hPts(x)}}
            }
            function renderPB(){const steps=SL(),ci=steps.indexOf(CV);document.getElementById('sw-pbar').innerHTML=steps.map((st,i)=>{
                let l,d;if(st==='setup'){l='Setup';d='‚öô'}else if(st==='project'){l='Project';d='P'}else if(st==='preview'){l='Export';d='‚úì'}
                else{const[pt,n]=st.split('-');d=n+'.'+{info:'1',voice:'2',points:'3'}[pt];l='S'+n+' '+{info:'Info',voice:'Voice',points:'Pts'}[pt]}
                return `<div class="sw-pstep ${i===ci?'on':i<ci?'done':''}" onclick="SW.navigateTo('${st}')"><div class="sw-pdot">${d}</div><div class="sw-plbl">${l}</div></div>`}).join('')}

            function H(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

            function hSetup(){return `<div class="sw-sec"><div class="sw-sh"><h2>How Many Songs?</h2><p>Every project starts here. How many individual songs does this customer need? Each song gets its own persona, story points, and songwriter brief.</p></div>
<div class="sw-scg">${[1,2,3,4,5,6].map(n=>`<button class="sw-scb ${SC===n?'sel':''}" onclick="SW.pickSC(${n})">${n}</button>`).join('')}</div>
<div style="text-align:center;margin-top:8px;font-size:13px;color:#888">${SC>0?`<strong style="color:#d4a574">${SC} song${SC>1?'s':''}</strong> selected`:'Select 1‚Äì6 songs'}</div>
<div class="sw-nf"><div></div><button class="sw-btn sw-btn-p" onclick="SW.goNext()" ${SC===0?'disabled':''}>Continue ‚Üí Project Details</button></div></div>`}

            function pickSC(n){SC=n;while(songs.length<n)songs.push(ES());if(songs.length>n)songs.length=n;render()}

            function hProj(){const p=proj;return `<div class="sw-sec"><div class="sw-sh"><h2>Project Details</h2><p>The event, the client, and what we're creating.</p></div>
<div class="sw-cd">
<div class="sw-fg"><label>Project / Event Name</label><input type="text" id="sw-pn" value="${H(p.projectName)}" placeholder='e.g. "The Sullivan ‚Äì Moriarity Wedding"'></div>
<div class="sw-fr"><div class="sw-fg"><label>Collection Type</label><select id="sw-ct">${['Demo Collection','Final Production','Rush Order','Custom'].map(o=>`<option ${p.collectionType===o?'selected':''}>${o}</option>`).join('')}</select></div>
<div class="sw-fg"><label>Event Date</label><input type="text" id="sw-ed" value="${H(p.eventDate)}" placeholder="e.g. September 14, 2025"></div></div>
<div class="sw-fg"><label>Creative Director</label><input type="text" id="sw-cd" value="${H(p.creativeDirector)}" placeholder="Your name"></div>
<div style="padding:16px 0 0;border-top:1px solid #333;margin-top:8px"><span style="font-size:13px;color:#888">This project has <strong style="color:#d4a574">${SC} song${SC>1?'s':''}</strong>. Each gets its own brief.</span></div></div>
<div class="sw-nf"><button class="sw-btn" onclick="SW.goPrev()">‚Üê Song Count</button><button class="sw-btn sw-btn-p" onclick="SW.goNext()">Continue ‚Üí Song 1 Info</button></div></div>`}

            function hInfo(x){const s=songs[x],n=x+1,P='sw-s'+x+'-';
const ots=['','Father-Daughter Dance','Mother-Son Dance','First Dance','Anniversary Song','Memorial / Tribute','Proposal','Birthday Tribute','Graduation','Corporate / Brand','Custom'];
const str=['Standard (Verse/Chorus)','Dual Perspective','Narrative / Through-composed',"Songwriter's Discretion"];
return `<div class="sw-sec"><div class="sw-badge"><div class="d"></div>Song ${n} of ${SC}</div>
<div class="sw-sh"><h2>Song ${n} ‚Äî Information</h2><p>Define this song's purpose, title, and emotional framing.</p></div>
<div class="sw-cd">
<div class="sw-fr"><div class="sw-fg"><label>Song Occasion / Type</label><select id="${P}st">${ots.map(o=>`<option value="${o}" ${s.songType===o?'selected':''}>${o||'‚Äî Select ‚Äî'}</option>`).join('')}</select></div>
<div class="sw-fg"><label>Custom Occasion</label><input type="text" id="${P}stc" value="${H(s.songTypeCustom)}" placeholder="If 'Custom' above"></div></div>
<div class="sw-fg"><label>Song Title</label><input type="text" id="${P}tt" value="${H(s.songTitle)}" placeholder="Working title"><div class="sw-ht">Can be refined by the songwriter.</div></div>
<div class="sw-fg"><label>Song Subtitle / Framing Line</label><input type="text" id="${P}sub" value="${H(s.songSubtitle)}" placeholder='e.g. "A father sings to his daughter on her wedding day"'><div class="sw-ht">One line that sets the emotional perspective.</div></div>
<div class="sw-fr"><div class="sw-fg"><label>Structure</label><select id="${P}str">${str.map(o=>`<option ${s.songStructure===o?'selected':''}>${o}</option>`).join('')}</select></div>
<div class="sw-fg"><label>Desired Tone</label><input type="text" id="${P}tn" value="${H(s.songTone)}" placeholder='e.g. "Stoic, tender, hard-won"'></div></div></div>
<div class="sw-nf"><button class="sw-btn" onclick="SW.goPrev()">‚Üê Back</button><button class="sw-btn sw-btn-p" onclick="SW.goNext()">Continue ‚Üí The Voice</button></div></div>`}

            function hVoice(x){const s=songs[x],n=x+1,P='sw-s'+x+'-';
return `<div class="sw-sec"><div class="sw-badge"><div class="d"></div>Song ${n} of ${SC}</div>
<div class="sw-sh"><h2>Song ${n} ‚Äî The Voice</h2><p>From your interview with the customer, build the persona whose voice the songwriter will write in.</p></div>
<div class="sw-cd sw-cd-g" style="margin-bottom:20px">
<div class="sw-fg" style="margin-bottom:12px"><label>Customer Being Interviewed</label><input type="text" id="${P}cn" value="${H(s.customerName)}" placeholder="Who are you interviewing? e.g. Emma Sullivan"></div>
<div class="sw-fg" style="margin-bottom:0"><label>Relationship to the Voice</label><input type="text" id="${P}cr" value="${H(s.customerRelationship)}" placeholder="e.g. Daughter ‚Äî telling us about her father Tom">
<div class="sw-ht">The customer tells us the stories. The voice below is who the song is written <em>as</em>.</div></div></div>
<div class="sw-cd"><div style="margin-bottom:20px"><span style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#d4a574;font-weight:600">Song Persona ‚Äî The Voice the Songwriter Writes As</span></div>
<div class="sw-fr3"><div class="sw-fg"><label>Name</label><input type="text" id="${P}sn" value="${H(s.singerName)}" placeholder="e.g. Tom Sullivan"></div>
<div class="sw-fg"><label>Age</label><input type="number" id="${P}sa" value="${H(s.singerAge)}" placeholder="61"></div>
<div class="sw-fg"><label>Singing To</label><input type="text" id="${P}sto" value="${H(s.singingTo)}" placeholder="e.g. His daughter Emma, 29"></div></div>
<div class="sw-fg"><label>Who They Are</label><input type="text" id="${P}sw" value="${H(s.singerWho)}" placeholder="How the customer described them"><div class="sw-ht">Ask: "Tell me about this person. What do they do?"</div></div>
<div class="sw-fg"><label>Background</label><textarea id="${P}sb" placeholder="Where they come from, cultural roots, family history.">${H(s.singerBackground)}</textarea><div class="sw-ht">Ask: "Where did they grow up? What shaped them?"</div></div>
<div class="sw-fg"><label>Personality</label><textarea id="${P}sp" placeholder="How they move through the world.">${H(s.singerPersonality)}</textarea><div class="sw-ht">Ask: "How would you describe their personality?"</div></div>
<div class="sw-fg"><label>Emotional Style</label><textarea id="${P}se" placeholder="How do they handle feelings?">${H(s.singerEmotional)}</textarea><div class="sw-ht">Ask: "How do they show love? What's hard for them?"</div></div>
<div class="sw-fg"><label>Voice in the Song</label><textarea id="${P}sv" placeholder="Your creative director note to the songwriter.">${H(s.singerVoice)}</textarea><div class="sw-ht">Synthesize what you heard into songwriter guidance.</div></div></div>
<div class="sw-nf"><button class="sw-btn" onclick="SW.goPrev()">‚Üê Back</button><button class="sw-btn sw-btn-p" onclick="SW.goNext()">Continue ‚Üí 10 Points</button></div></div>`}

            function hPts(x){const s=songs[x],n=x+1,P='sw-s'+x+'-';
let cards='';for(let i=0;i<10;i++){cards+=`<div class="sw-pc"><div class="sw-pch"><div class="sw-pn">${i+1}</div><div class="sw-pti"><input type="text" id="${P}p${i}t" value="${H(s.points[i].title)}" placeholder="Moment title"></div></div>
<div class="sw-fg" style="margin-bottom:0"><textarea class="sw-tl" id="${P}p${i}b" placeholder="What did the customer tell you about this moment?">${H(s.points[i].body)}</textarea></div></div>`}
const isLast=x===SC-1,nxt=isLast?'Preview &amp; Export ‚Üí':'Continue ‚Üí Song '+(x+2)+' Info',act=isLast?"SW.navigateTo('preview')":"SW.goNext()";
return `<div class="sw-sec"><div class="sw-badge"><div class="d"></div>Song ${n} of ${SC}</div>
<div class="sw-sh"><h2>Song ${n} ‚Äî 10 Points</h2><p>The moments, memories, and emotional truths from your interview. Each is a story only someone who listened would know.</p></div>
${cards}
<div class="sw-cd" style="margin-top:24px"><div class="sw-fg" style="margin-bottom:0"><label>Singer's Voice ‚Äî In Their Own Words</label>
<textarea class="sw-tl" id="${P}q" placeholder="Capture how the song's voice would express themselves.">${H(s.singerQuote)}</textarea>
<div class="sw-ht">The closing quote that gives the songwriter the singer's authentic voice.</div></div></div>
<div class="sw-nf"><button class="sw-btn" onclick="SW.goPrev()">‚Üê Back</button><button class="sw-btn sw-btn-p" onclick="${act}">${nxt}</button></div></div>`}

            function hPrev(){saveDOM();const p=proj;let allH='';
for(let i=0;i<SC;i++){const s=songs[i],n=i+1,ty=s.songType==='Custom'?s.songTypeCustom:s.songType,fp=s.points.filter(t=>t.title||t.body);
let ph='';fp.forEach((t,j)=>{ph+=`<div class="sw-pvpt"><strong>${j+1}. ${t.title||'(Untitled)'}</strong> ‚Äî ${t.body||'<em>No details.</em>'}</div>`});
if(i>0)allH+=`<div class="sw-pvsh"><strong style="font-size:12px;letter-spacing:3px;color:#999">SONG ${n}</strong></div>`;
allH+=`<div style="text-align:center;margin:20px 0"><strong style="font-size:15px;letter-spacing:1px">${(ty||'SONG '+n).toUpperCase()}</strong><br>
<span style="font-size:20px;font-style:italic">\u201C${s.songTitle||'Untitled'}\u201D</span><br><em style="color:#666;font-size:13px">${s.songSubtitle||''}</em></div><hr class="sw-pvrl">
<div class="sw-pvst">Singer Persona: ${s.singerName||'\u2014'}</div>
<div class="sw-pvpb"><strong>Age:</strong> ${s.singerAge||'\u2014'}<br><strong>Who They Are:</strong> ${s.singerWho||'\u2014'}<br><strong>Background:</strong> ${s.singerBackground||'\u2014'}<br><strong>Personality:</strong> ${s.singerPersonality||'\u2014'}<br><strong>Emotional Style:</strong> ${s.singerEmotional||'\u2014'}<br><strong>Voice in the Song:</strong> ${s.singerVoice||'\u2014'}<br><strong>Singing To:</strong> ${s.singingTo||'\u2014'}</div>
<div class="sw-pvst">10 Points for the Songwriter</div>${ph||'<p style="color:#999;font-style:italic">No points yet.</p>'}
${s.singerQuote?`<div class="sw-pvvb"><strong>SINGER\u2019S VOICE:</strong> \u201C${s.singerQuote}\u201D</div>`:''}`}
const sm=songs.map((s,i)=>(s.songType==='Custom'?s.songTypeCustom:s.songType)||'Song '+(i+1)).join(' \u2022 ');
return `<div class="sw-sec"><div class="sw-sh"><h2>Preview &amp; Export</h2><p>Review the complete brief ‚Äî all ${SC} song${SC>1?'s':''} ‚Äî before exporting.</p></div>
<div class="sw-pvc">
<div class="sw-pvb">PERSONATA STUDIOS</div><hr class="sw-pvr"><div class="sw-pvt">Songwriter Briefs</div><div class="sw-pvs"><em>Singer Personas &amp; 10-Point Song Maps</em></div><hr class="sw-pvr">
<div class="sw-pvm">${p.projectName||'Untitled Project'} \u2022 ${p.collectionType}${p.eventDate?' \u2022 '+p.eventDate:''}<br>${sm}<br>${p.creativeDirector?'Creative Director: '+p.creativeDirector:''}</div>
${allH}
<hr class="sw-pvr" style="margin-top:32px"><div class="sw-pvf">PERSONATA STUDIOS<br><em style="font-size:11px;letter-spacing:0">Every song has a story. We make sure yours is heard.</em><br>personatastudios.com</div></div>
<div class="sw-nf"><button class="sw-btn" onclick="SW.goPrev()">‚Üê Edit</button><button class="sw-btn sw-btn-p" onclick="SW.exportDocx()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export .docx</button></div></div>`}

            async function exportDocx(){
                saveDOM();const p=proj;
                const{Document,Packer,Paragraph,TextRun,Table,TableRow,TableCell,AlignmentType,BorderStyle,WidthType,PageBreak}=docx;
                const bdr={style:BorderStyle.SINGLE,size:1,color:"999999"},bds={top:bdr,bottom:bdr,left:bdr,right:bdr};
                function pr(l,v){return new Paragraph({spacing:{after:60},children:[new TextRun({text:l,bold:true,font:"Georgia",size:22}),new TextRun({text:v||"\u2014",font:"Georgia",size:22})]})}
                function rl(){return new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"\u2501".repeat(50),font:"Georgia",size:18,color:"666666"})]})}
                const ch=[];
                const sm=songs.map((s,i)=>(s.songType==='Custom'?s.songTypeCustom:s.songType)||'Song '+(i+1)).join(' \u2022 ');
                ch.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:80},children:[new TextRun({text:"PERSONATA STUDIOS",bold:true,font:"Georgia",size:28,characterSpacing:200})]}),rl(),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"Songwriter Briefs",font:"Georgia",size:36})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"Singer Personas & 10-Point Song Maps",italics:true,font:"Georgia",size:22,color:"666666"})]}),rl(),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:80},children:[new TextRun({text:p.projectName||'Untitled Project',font:"Georgia",size:24})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:`${p.collectionType} \u2022 ${SC} Song${SC>1?'s':''} \u2022 ${SC} Singer${SC>1?'s':''} \u2022 ${SC} Stor${SC>1?'ies':'y'}`,font:"Georgia",size:20,color:"666666"})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:200},children:[new TextRun({text:"Each brief contains a singer persona and 10 key emotional/narrative points designed to guide the songwriter through the story the song needs to tell.",italics:true,font:"Georgia",size:20,color:"888888"})]}));

                for(let i=0;i<SC;i++){const s=songs[i],n=i+1,ty=s.songType==='Custom'?s.songTypeCustom:s.songType,fp=s.points.filter(t=>t.title||t.body);
                    if(i>0)ch.push(new Paragraph({children:[new PageBreak()]}));
                    ch.push(new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:60},children:[new TextRun({text:`SONG ${n} \u2022 ${(ty||'UNTITLED').toUpperCase()}`,bold:true,font:"Georgia",size:26})]}),
                        new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:60},children:[new TextRun({text:`\u201C${s.songTitle||'Untitled'}\u201D`,italics:true,font:"Georgia",size:32})]}),
                        new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:100},children:[new TextRun({text:s.songSubtitle||'',italics:true,font:"Georgia",size:22,color:"666666"})]}),rl(),
                        new Paragraph({spacing:{before:200,after:160},children:[new TextRun({text:`Singer Persona: ${s.singerName||'\u2014'}`,bold:true,font:"Georgia",size:26})]}),
                        new Table({width:{size:9360,type:WidthType.DXA},columnWidths:[9360],rows:[new TableRow({children:[new TableCell({borders:bds,width:{size:9360,type:WidthType.DXA},margins:{top:120,bottom:120,left:200,right:200},
                            children:[pr("Age: ",s.singerAge),pr("Who They Are: ",s.singerWho),pr("Background: ",s.singerBackground),pr("Personality: ",s.singerPersonality),pr("Emotional Style: ",s.singerEmotional),pr("Voice in the Song: ",s.singerVoice),pr("Singing To: ",s.singingTo)]})]})]})
                    );
                    ch.push(new Paragraph({spacing:{before:360,after:200},children:[new TextRun({text:"10 POINTS FOR THE SONGWRITER",bold:true,font:"Georgia",size:26})]}));
                    fp.forEach((t,j)=>{ch.push(new Paragraph({spacing:{before:200,after:80},indent:{left:360},children:[new TextRun({text:`${j+1}. ${t.title||'(Untitled)'}`,bold:true,font:"Georgia",size:22}),new TextRun({text:` \u2014 ${t.body||''}`,font:"Georgia",size:22})]}))});
                    if(s.singerQuote){ch.push(new Paragraph({spacing:{before:300},children:[]}),
                        new Table({width:{size:9360,type:WidthType.DXA},columnWidths:[9360],rows:[new TableRow({children:[new TableCell({borders:bds,width:{size:9360,type:WidthType.DXA},margins:{top:120,bottom:120,left:200,right:200},
                            children:[new Paragraph({children:[new TextRun({text:"SINGER\u2019S VOICE: ",bold:true,font:"Georgia",size:22}),new TextRun({text:`\u201C${s.singerQuote}\u201D`,italics:true,font:"Georgia",size:22})]})]})]})]}))}
                }
                ch.push(new Paragraph({children:[new PageBreak()]}),rl(),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{before:200,after:120},children:[new TextRun({text:`${SC} Song${SC>1?'s':''}. ${SC} Voice${SC>1?'s':''}. One ${p.projectName?p.projectName.split(' ').pop():'Story'}.`,font:"Georgia",size:24})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"Each persona is a real person with a real story.",font:"Georgia",size:22,color:"666666"})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:120},children:[new TextRun({text:"Each point is a moment that only emerged because someone listened.",italics:true,font:"Georgia",size:22,color:"666666"})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"That\u2019s the Personata Studios difference.",italics:true,font:"Georgia",size:22,color:"999999"})]}),rl(),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{before:120,after:40},children:[new TextRun({text:"PERSONATA STUDIOS",bold:true,font:"Georgia",size:22,characterSpacing:200})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,spacing:{after:40},children:[new TextRun({text:"Every song has a story. We make sure yours is heard.",italics:true,font:"Georgia",size:20,color:"666666"})]}),
                    new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"personatastudios.com",font:"Georgia",size:20,color:"999999"})]}));

                const doc=new Document({styles:{default:{document:{run:{font:"Georgia",size:22}}}},sections:[{properties:{page:{size:{width:12240,height:15840},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:ch}]});
                const blob=await Packer.toBlob(doc);
                saveAs(blob,p.projectName?`Personata_Briefs_${p.projectName.replace(/[^a-zA-Z0-9]/g,'_')}.docx`:'Personata_Songwriter_Briefs.docx');
                toast(`Exported ${SC} song brief${SC>1?'s':''}!`);
            }

            function resetAll(){if(!confirm('Clear everything and start over?'))return;SC=0;songs=[];proj={projectName:'',collectionType:'Demo Collection',eventDate:'',creativeDirector:''};CV='setup';navigateTo('setup');toast('All cleared.')}

            function init(){navigateTo('setup')}

            return {navigateTo, goNext, goPrev, pickSC, exportDocx, resetAll, init};
        })();

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
